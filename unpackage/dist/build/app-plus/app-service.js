if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((n=>t.resolve(e()).then((()=>n))),(n=>t.resolve(e()).then((()=>{throw n}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...n){uni.__log__?uni.__log__(e,t,...n):console[e].apply(console,[...n,t])}const n={dbName:"Smart_Ruler",dbPath:"_downloads/Smart_Ruler.db",copyDatabase(){"undefined"!=typeof plus?plus.io.resolveLocalFileSystemURL("/static/_db/test.db",(function(e){plus.io.resolveLocalFileSystemURL("_doc",(function(n){e.copyTo(n,"test.db",(function(){t("log","at api/sqlite.js:14","拷贝成功")}),(function(e){t("log","at api/sqlite.js:16","拷贝失败",e)}))}),(function(e){t("log","at api/sqlite.js:19","获取 _doc 失败",e)}))}),(function(e){t("log","at api/sqlite.js:22","找不到数据库文件",e)})):t("warn","at api/sqlite.js:7","plus API 不可用，请在App中运行")},isOpen(){return plus.sqlite.isOpenDatabase({name:this.dbName,path:this.dbPath})},openSqlite(){return new Promise(((e,t)=>{plus.sqlite.openDatabase({name:this.dbName,path:this.dbPath,success(t){e(t)},fail(e){t(e)}})}))},closeSqlite(){return new Promise(((e,t)=>{plus.sqlite.closeDatabase({name:this.dbName,success(t){e(t)},fail(e){t(e)}})}))},createTable(e,t){return new Promise(((n,a)=>{plus.sqlite.executeSql({name:this.dbName,sql:`CREATE TABLE IF NOT EXISTS ${e}(${t})`,success(e){n(e)},fail(e){a(e)}})}))},dropTable(e){return new Promise(((t,n)=>{plus.sqlite.executeSql({name:this.dbName,sql:`DROP TABLE ${e}`,success(e){t(e)},fail(e){n(e)}})}))},insertTableData(e,t,n){if(void 0!==e&&void 0!==t){if("{}"==JSON.stringify(t))return new Promise(((e,t)=>{t("错误添加")}));if(null==n)var a=`INSERT INTO ${e} VALUES('${t}')`;else a=`INSERT INTO ${e} (${n}) VALUES(${t})`;return new Promise(((e,t)=>{plus.sqlite.executeSql({name:this.dbName,sql:a,success(t){e(t)},fail(e){t(e)}})}))}return new Promise(((e,t)=>{t("错误添加")}))},insertOrReplaceData(e,t,n){if(void 0!==e&&void 0!==t){if(null==n)var a=`INSERT OR REPLACE INTO ${e} VALUES('${t}')`;else a=`INSERT OR REPLACE INTO ${e} (${n}) VALUES(${t})`;return new Promise(((e,t)=>{plus.sqlite.executeSql({name:this.dbName,sql:a,success(t){e(t)},fail(e){t(e)}})}))}return new Promise(((e,t)=>{t("错误添加")}))},selectTableData(e,n={}){if(!e)return Promise.reject("错误查询：表名不能为空");let a=[];for(const t in n)n[t]&&a.push(`${t} = '${n[t]}'`);const s=`SELECT * FROM ${e} ${a.length>0?`WHERE ${a.join(" AND ")}`:""}`;return new Promise(((e,n)=>{plus.sqlite.selectSql({name:this.dbName,sql:s,success(t){e(t)},fail(e){t("error","at api/sqlite.js:205","查询失败",e),n(e)}})}))},selectTableDataByPage(e,t=1,n=5){const a=`SELECT * FROM ${e} LIMIT ${n} OFFSET ${(t-1)*n}`;return new Promise(((e,t)=>{plus.sqlite.selectSql({name:this.dbName,sql:a,success:e,fail:t})}))},deleteTable(e){return new Promise(((t,n)=>{plus.sqlite.executeSql({name:this.dbName,sql:`DROP TABLE ${e}`,success:t,fail:n})}))},deleteTableData(e,t={}){if(!e)return Promise.reject("表名不能为空");let n=`DELETE FROM ${e}`;const a=Object.keys(t);if(a.length>0){const e=a.map((e=>{const n=t[e];return`${e} = ${"number"==typeof n?n:`'${n}'`}`})).join(" AND ");n+=` WHERE ${e}`}return new Promise(((e,t)=>{plus.sqlite.executeSql({name:this.dbName,sql:n,success(t){e(t)},fail(e){t(e)}})}))},updateTableData(e,t,n,a){if(null==n)var s=`UPDATE ${e} SET ${t}`;else s=`UPDATE ${e} SET ${t} WHERE ${n} = '${a}'`;return new Promise(((e,t)=>{plus.sqlite.executeSql({name:this.dbName,sql:s,success(t){e(t)},fail(e){t(e)}})}))},pullSQL(e,t,n){return new Promise(((a,s)=>{plus.sqlite.selectSql({name:this.dbName,sql:`SELECT * FROM ${e} ORDER BY '${t}' DESC LIMIT 15 OFFSET '${n}'`,success(e){a(e)},fail(e){s(e)}})}))}},a="/static/image/blu.png",s="/static/image/next.png",o=(e,t)=>{const n=e.__vccOpts||e;for(const[a,s]of t)n[a]=s;return n};const i=o({data:()=>({projects:[],device:{Name:"未连接到设备，请链接设备"},page:1,pageSize:10,hasMore:!0,pressedIndex:-1,isDeleting:!1,isLoading:!1,isLoadingMore:!1}),async onLoad(e){this.device.Name=e.deviceName||"未连接到设备，请链接设备",await this.waitForDatabase(),await this.resetAndLoad()},onShow(){const e=getApp();e&&e.globalData&&e.globalData.dbInitialized&&this.resetAndLoad()},methods:{async resetAndLoad(){this.isLoading||(this.projects=[],this.page=1,this.hasMore=!0,await this.loaddata())},waitForDatabase:()=>new Promise((e=>{const t=()=>{const n=getApp();n&&n.globalData&&n.globalData.dbInitialized?e():setTimeout(t,100)};t()})),connectDevice(){uni.navigateTo({url:"/pages/device/device"})},createProject(){uni.navigateTo({url:"/pages/newProject/newProject"})},inProject(e){uni.showToast({title:e.title,icon:"none"}),uni.navigateTo({url:`/pages/inProject/inProject?id=${e.id}`})},selectTableDataByPage(){return new Promise(((e,t)=>{n.selectTableDataByPage("project",this.page,this.pageSize).then((t=>{e(t)})).catch((e=>{t(e)}))}))},async loaddata(){const e=getApp();if(e&&e.globalData&&e.globalData.dbInitialized)if(this.isLoading)t("log","at pages/index/index.vue:171","正在加载中，跳过重复加载");else{this.isLoading=!0;try{t("log","at pages/index/index.vue:177","加载第",this.page,"页，每页",this.pageSize,"条");const e=await this.selectTableDataByPage();1===this.page?this.projects=e:this.projects=[...this.projects,...e],this.hasMore=e.length>=this.pageSize}catch(n){t("error","at pages/index/index.vue:192","数据载入失败：",n),uni.showToast({title:"数据载入失败",icon:"none"})}finally{this.isLoading=!1}}else t("log","at pages/index/index.vue:166","数据库未初始化，跳过加载")},async loadMore(){if(this.hasMore&&!this.isLoading&&!this.isLoadingMore){this.isLoadingMore=!0;try{this.page++,await this.loaddata()}finally{this.isLoadingMore=!1}}},handleLongPress(e,t){uni.vibrateShort({success:()=>{this.pressedIndex=t,this.confirmDelete(e,t)}})},confirmDelete(e,t){this.isDeleting||uni.showModal({title:"删除项目",content:`确定要删除项目「${this.formatProjectTitle(e)}」吗？\n删除后数据将无法恢复。`,confirmText:"删除",cancelText:"取消",confirmColor:"#e64340",success:async n=>{n.confirm&&await this.deleteProject(e.id,t),this.pressedIndex=-1},fail:()=>{this.pressedIndex=-1}})},async deleteProject(e,a){if(!this.isDeleting){this.isDeleting=!0,uni.showLoading({title:"正在删除...",mask:!0});try{await n.deleteTableData("wall_data",{project_id:e}),await n.deleteTableData("sections",{project_id:e}),await n.deleteTableData("warning_settings",{project_id:e}),await n.deleteTableData("project",{id:e}),this.projects.splice(a,1),uni.showToast({title:"删除成功",icon:"success"})}catch(s){t("error","at pages/index/index.vue:267","删除失败",s),uni.showToast({title:"删除失败",icon:"none",duration:2e3})}finally{uni.hideLoading(),this.isDeleting=!1}}},formatProjectTitle(e){let t=e.title||"";return e.building&&(t+="-"+e.building),e.unit&&(t+="-"+e.unit),e.floor&&(t+="-"+e.floor),e.room_number&&(t+="-"+e.room_number),t}}},[["render",function(t,n,o,i,l,c){return e.openBlock(),e.createElementBlock("view",{class:"main"},[e.createElementVNode("view",{class:"container"},[e.createElementVNode("view",{class:"title-bar"},[e.createElementVNode("text",{class:"title"},"我的设备")]),e.createElementVNode("view",{class:"device-card",onClick:n[0]||(n[0]=(...e)=>c.connectDevice&&c.connectDevice(...e))},[e.createElementVNode("image",{src:a,class:"device-icon",mode:"aspectFit"}),e.createElementVNode("view",{class:"device-info"},[e.createElementVNode("view",null,[e.createElementVNode("text",{class:"device-title"},"我的设备")]),e.createElementVNode("view",null,[e.createElementVNode("text",{class:"device-subtitle"},e.toDisplayString(l.device.Name),1)])]),e.createElementVNode("image",{src:s,class:"arrow-icon",mode:"aspectFit"})]),e.createElementVNode("view",{class:"myproject"},[e.createElementVNode("text",{class:"section-title"},"我的项目"),e.createElementVNode("text",{class:"section-subtitle"},"长按可删除项目")]),e.createElementVNode("scroll-view",{"scroll-y":"true",class:"scroll-area",onScrolltolower:n[1]||(n[1]=(...e)=>c.loadMore&&c.loadMore(...e))},[e.createElementVNode("view",{class:"project-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(l.projects,((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["project-item",{"project-item-pressed":l.pressedIndex===n}]),key:n,onLongpress:e=>c.handleLongPress(t,n),onClick:e=>c.inProject(t)},[e.createElementVNode("image",{src:t.icon,class:"project-icon",mode:"aspectFit"},null,8,["src"]),e.createElementVNode("view",{class:"project-content"},[e.createElementVNode("view",{class:"project-title-box"},[e.createElementVNode("text",{class:"project-title"},e.toDisplayString(c.formatProjectTitle(t)),1)]),e.createElementVNode("view",{class:"project-address-box"},[e.createElementVNode("text",{class:"project-address"},e.toDisplayString(t.address),1)]),e.createElementVNode("view",{class:"project-date-box"},[e.createElementVNode("text",{class:"project-date"},e.toDisplayString(t.date),1)]),e.createElementVNode("view",{class:"project-type-box"},[e.createElementVNode("text",{class:"project-type"},"项目类型："+e.toDisplayString(t.type_tag),1),e.createElementVNode("text",{class:"project-status"},"验收类型："+e.toDisplayString(t.project_status),1)]),e.createElementVNode("view",{class:"project-type-box"},[e.createElementVNode("view",null,[e.createTextVNode("验收状态："),e.createElementVNode("text",{class:e.normalizeClass(["project-inspection",{"green-text":"已验收"===t.inspection_status,"gray-text":"已验收"!==t.inspection_status}])},e.toDisplayString(t.inspection_status),3)]),"已验收"===t.inspection_status?(e.openBlock(),e.createElementBlock("text",{key:0,class:"project-inspector"},"项目质检员："+e.toDisplayString(t.inspector),1)):e.createCommentVNode("",!0)])]),e.createElementVNode("image",{src:s,class:"arrow-icon",mode:"aspectFit"})],42,["onLongpress","onClick"])))),128))])],32),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"new-project-btn",onClick:n[2]||(n[2]=(...e)=>c.createProject&&c.createProject(...e))},"新建项目")])])])}]]);const l=o({data:()=>({devices:[],connectedDeviceId:null}),onLoad(){this.startBluetoothDiscovery()},methods:{startBluetoothDiscovery(){this.devices=[],uni.openBluetoothAdapter({success:()=>{uni.startBluetoothDevicesDiscovery({allowDuplicatesKey:!1,success:()=>{this.listenForDevices()}})},fail:e=>{uni.showToast({title:"请开启蓝牙",icon:"none"})}})},listenForDevices(){uni.onBluetoothDeviceFound((e=>{e.devices.forEach((e=>{if(!e.name&&!e.localName)return;this.devices.find((t=>t.deviceId===e.deviceId))||this.devices.push({...e,status:"未连接"})}))}))},async connectToDevice(e){this.connectedDeviceId&&this.connectedDeviceId!==e&&await this.disconnectDevice(this.connectedDeviceId),uni.createBLEConnection({deviceId:e,success:()=>{uni.showToast({title:"连接成功",icon:"success"}),this.connectedDeviceId=e,this.updateDeviceStatus(e,"已连接"),setTimeout((()=>{this.getDeviceServices(e)}),1500)},fail:e=>{uni.showToast({title:"连接失败",icon:"none"}),t("error","at pages/device/device.vue:90","连接失败",e)}})},getDeviceServices(e){uni.getBLEDeviceServices({deviceId:e,success:n=>{t("log","at pages/device/device.vue:100","服务列表：",n.services);const a=n.services.find((e=>e.isPrimary));a?this.getDeviceCharacteristics(e,a.uuid):uni.showToast({title:"无主服务",icon:"none"})},fail:e=>{t("error","at pages/device/device.vue:109","获取服务失败",e)}})},getDeviceCharacteristics(e,n){uni.getBLEDeviceCharacteristics({deviceId:e,serviceId:n,success:e=>{t("log","at pages/device/device.vue:120","特征值列表：",e.characteristics)},fail:e=>{t("error","at pages/device/device.vue:123","获取特征值失败",e)}})},disconnectDevice(e){return new Promise((t=>{uni.closeBLEConnection({deviceId:e,success:()=>{this.updateDeviceStatus(e,"未连接"),this.connectedDeviceId=null,t()},fail:()=>{t()}})}))},updateDeviceStatus(e,t){this.devices=this.devices.map((n=>({...n,status:n.deviceId===e?t:"未连接"})))}},onUnload(){this.connectedDeviceId&&uni.closeBLEConnection({deviceId:this.connectedDeviceId}),uni.stopBluetoothDevicesDiscovery(),uni.closeBluetoothAdapter()}},[["render",function(t,n,s,o,i,l){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"附近蓝牙设备"),e.createElementVNode("button",{class:"refresh-btn",onClick:n[0]||(n[0]=(...e)=>l.startBluetoothDiscovery&&l.startBluetoothDiscovery(...e))},"刷新")]),e.createElementVNode("scroll-view",{"scroll-y":"",class:"device-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(i.devices,((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"device-item",key:n,onClick:e=>l.connectToDevice(t.deviceId,n)},[e.createElementVNode("view",{class:"device-icon-box"},[e.createElementVNode("image",{src:a,class:"device-icon",mode:"aspectFit"})]),e.createElementVNode("view",{class:"device-info-box"},[e.createElementVNode("text",{class:"device-name"},e.toDisplayString(t.name||"未知设备"),1),e.createElementVNode("text",{class:"device-id"},e.toDisplayString(t.deviceId),1),e.createElementVNode("text",{class:"device-status"},"连接状态："+e.toDisplayString(t.status||"未连接"),1)])],8,["onClick"])))),128))])])}]]),c="/static/image/csv.png";const r=o({methods:{select(e){"csv"===e?uni.navigateTo({url:"/pages/newProject/csv/csv"}):"template"===e?uni.navigateTo({url:"/pages/newProject/template/template"}):"text"===e&&uni.navigateTo({url:"/pages/newProject/text/text"})}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"}),e.createElementVNode("view",{class:"tip"},"请选择创建方式"),e.createElementVNode("view",{class:"option-list"},[e.createElementVNode("view",{class:"option",onClick:n[0]||(n[0]=e=>i.select("csv"))},[e.createElementVNode("image",{src:c,class:"icon"}),e.createElementVNode("view",{class:"info"},[e.createElementVNode("text",{class:"main"},"通过CSV表格文件创建"),e.createElementVNode("text",{class:"sub"},"自定义验收表格的内容")])]),e.createElementVNode("view",{class:"option",onClick:n[1]||(n[1]=e=>i.select("template"))},[e.createElementVNode("image",{src:"/static/image/template.png",class:"icon"}),e.createElementVNode("view",{class:"info"},[e.createElementVNode("text",{class:"main"},"通过通用模板创建"),e.createElementVNode("text",{class:"sub"},"通用性的房屋验收模板")])]),e.createElementVNode("view",{class:"option",onClick:n[2]||(n[2]=e=>i.select("text"))},[e.createElementVNode("image",{src:"/static/image/text.png",class:"icon"}),e.createElementVNode("view",{class:"info"},[e.createElementVNode("text",{class:"main"},"通过文本创建"),e.createElementVNode("text",{class:"sub"},"根据规范创建文本，粘贴文本创建项目")])])])])}],["__scopeId","data-v-386c79b4"]]),p={generateCSVContent(e={}){const{projectInfo:t={},warningSettings:n={},showSlope:a=!0,showFlatness:s=!0,isOverWarning:o=(()=>!1),sections:i=[],sectionData:l={}}=e;let c="";c+=["项目名称","项目地址","验收日期","栋","单元","楼层","房号","项目类型","验收类型","验收状态","项目质检员"].join(",")+"\n";const r=[`"${t.title||""}"`,`"${t.address||""}"`,`"${t.date||""}"`,`"${t.building||""}"`,`"${t.unit||""}"`,`"${t.floor||""}"`,`"${t.room_number||""}"`,`"${t.type_tag||""}"`,`"${t.project_status||""}"`,`"${t.inspection_status||""}"`,`"${t.inspector||""}"`];c+=r.join(",")+"\n";let p="预警值设置：";a&&(p+=`坡度预警值(mm/M)：${n.slopeWarning||"未设置"}`),s&&(a&&(p+="，"),p+=`平整度预警值(mm)：${n.flatnessWarning||"未设置"}`),c+=p+"\n";let d=["房间","墙体"];return a&&d.push("坡度(mm/M)"),s&&d.push("平整度(mm)"),d.push("预警状态"),c+=d.join(",")+"\n",i.forEach((e=>{const t=l[e];let i=!1;if(t&&t.length>0&&t.forEach((t=>{if(a&&t.slope||s&&t.flatness){i=!0;let l=[`"${e}"`,`"${t.name}"`];a&&l.push(`"${t.slope||""}"`),s&&l.push(`"${t.flatness||""}"`);let r="否";if(o&&"function"==typeof o){const e=parseFloat(t.slope)||0,o=parseFloat(t.flatness)||0,i=parseFloat(n.slopeWarning)||0,l=parseFloat(n.flatnessWarning)||0;(a&&e>i&&i>0||s&&o>l&&l>0)&&(r="是")}l.push(`"${r}"`),c+=l.join(",")+"\n"}})),!i){let t=[`"${e}"`,'"暂无数据"'];a&&t.push('""'),s&&t.push('""'),t.push('"否"'),c+=t.join(",")+"\n"}})),c},parseCSVContent(e){try{const t=e.split("\n").map((e=>e.trim())).filter((e=>e)),n=t[0].split(",").map((e=>e.trim())),a=t[1].split(",").map((e=>e.trim().replace(/^"(.*)"$/,"$1"))),s={};n.forEach(((e,t)=>{s[e]=a[t]||""}));const o=t[2],i={},l=o.match(/坡度预警值\(mm\/M\)：(\d+\.?\d*)/),c=o.match(/平整度预警值\(mm\)：(\d+\.?\d*)/);l&&(i.slopeWarning=l[1]),c&&(i.flatnessWarning=c[1]);const r=t.slice(3),p=r[0].split(",").map((e=>e.trim().replace(/^"(.*)"$/,"$1"))),d=(p.findIndex((e=>"房间"===e||"区域"===e)),p.findIndex((e=>"墙体"===e)),p.findIndex((e=>"坡度(mm/M)"===e||"坡度"===e))),m=p.findIndex((e=>"平整度(mm)"===e||"平整度"===e)),u=r.slice(1).map((e=>{const t=e.split(",").map((e=>e.trim().replace(/^"(.*)"$/,"$1"))),n=[];return p.forEach(((e,a)=>{a<t.length&&("房间"===e||"区域"===e||"墙体"===e||"坡度(mm/M)"===e||"坡度"===e||"平整度(mm)"===e||"平整度"===e)?n.push(t[a]):"房间"!==e&&"区域"!==e&&"墙体"!==e&&"坡度(mm/M)"!==e&&"坡度"!==e&&"平整度(mm)"!==e&&"平整度"!==e||n.push("")})),n})),h=p.filter((e=>"房间"===e||"区域"===e||"墙体"===e||"坡度(mm/M)"===e||"坡度"===e||"平整度(mm)"===e||"平整度"===e)),g=u.map((e=>{const t=[];return p.forEach(((n,a)=>{h.includes(n)&&a<e.length&&t.push(e[a])})),t}));return{projectInfo:s,warningSettings:i,headers:h,tableData:g,showSlope:d>-1,showFlatness:m>-1}}catch(n){return t("error","at utils/csvUtils.js:234","解析CSV数据失败:",n),null}},calculateFileSize(e){const t=e.length;return t<1024?t+" B":t<1048576?(t/1024).toFixed(2)+" KB":(t/1048576).toFixed(2)+" MB"},processCSVContent(e){try{const t=e.split("\n").map((e=>e.trim())).filter((e=>e)),n=t.slice(0,3),a=t[3],s=t.slice(4);return[...n,a,...s].join("\n")}catch(n){return t("error","at utils/csvUtils.js:273","处理CSV内容失败:",n),e}}};const d=o({data:()=>({fullAddress:"",currentIndex:0,id:0,project:{},showNameInput:!1,newWallName:"",sections:[],sectionData:{},autoSaveTimer:null,pendingSave:!1,showSettings:!1,warningSettings:{slopeWarning:"",flatnessWarning:""},projectType:"",showSectionInput:!1,newSectionName:"",isEditingSection:!1,editingSectionOldName:""}),computed:{showSlope(){return"坡度"===this.projectType||"坡度加平整度"===this.projectType},showFlatness(){return"平整度"===this.projectType||"坡度加平整度"===this.projectType}},methods:{async initWallTable(){try{await n.createTable("wall_data",'\n          "id" INTEGER PRIMARY KEY AUTOINCREMENT,\n          "project_id" INTEGER NOT NULL,\n          "section" TEXT NOT NULL,\n          "wall_name" TEXT NOT NULL,\n          "slope" TEXT,\n          "flatness" TEXT,\n          "image" TEXT,\n          FOREIGN KEY(project_id) REFERENCES project(id)\n        '),t("log","at pages/inProject/inProject.vue:213","墙体数据表创建成功")}catch(e){t("error","at pages/inProject/inProject.vue:215","创建墙体数据表失败:",e)}},async loadWallData(){try{const e=await n.selectTableData("wall_data",{project_id:this.id});this.sections.forEach((e=>{this.sectionData[e]=[]})),e.forEach((e=>{const t=e.section;t&&this.sectionData[t]&&this.sectionData[t].push({name:e.wall_name,slope:e.slope||"",flatness:e.flatness||"",image:e.image||"",id:e.id})}))}catch(e){t("error","at pages/inProject/inProject.vue:244","加载墙体数据失败:",e),uni.showToast({title:"加载数据失败",icon:"none"})}},async autoSave(){if(this.pendingSave)try{for(const e in this.sectionData){const t=this.sectionData[e];for(const a of t){let t=[],s=[],o=[];if(this.showSlope&&(t.push(`slope='${a.slope||""}'`),s.push("slope"),o.push(`'${a.slope||""}'`)),this.showFlatness&&(t.push(`flatness='${a.flatness||""}'`),s.push("flatness"),o.push(`'${a.flatness||""}'`)),a.id)t.length>0&&await n.updateTableData("wall_data",t.join(","),"id",a.id);else{const t=["id","project_id","section","wall_name","image"],i=["null",`'${this.id}'`,`'${e}'`,`'${a.name}'`,`'${a.image||""}'`];await n.insertTableData("wall_data",[...i,...o].join(","),[...t,...s].join(","))}}}this.pendingSave=!1,t("log","at pages/inProject/inProject.vue:301","自动保存成功")}catch(e){t("error","at pages/inProject/inProject.vue:303","自动保存失败:",e),uni.showToast({title:"保存失败",icon:"none"})}},handleDataChange(){this.pendingSave=!0,this.autoSaveTimer&&clearTimeout(this.autoSaveTimer),this.autoSaveTimer=setTimeout((()=>{this.autoSave()}),2e3)},handleInput(e,t,n){e[t]=n,this.handleDataChange()},async saveImageToLocal(e){try{const n=uni.getSystemInfoSync().platform;if("android"===n||"ios"===n)return new Promise(((n,a)=>{const s=`${(new Date).getTime()}_${Math.floor(1e3*Math.random())}${e.substring(e.lastIndexOf("."))}`,o=`_doc/images/${s}`;plus.io.resolveLocalFileSystemURL("_doc/",(i=>{i.getDirectory("images",{create:!0},(i=>{plus.io.resolveLocalFileSystemURL(e,(e=>{e.copyTo(i,s,(()=>{n(o)}),(e=>{t("error","at pages/inProject/inProject.vue:358","复制文件失败:",e),a(e)}))}),(e=>{t("error","at pages/inProject/inProject.vue:362","解析源文件失败:",e),a(e)}))}),(e=>{t("error","at pages/inProject/inProject.vue:366","创建目录失败:",e),a(e)}))}),(e=>{t("error","at pages/inProject/inProject.vue:370","获取根目录失败:",e),a(e)}))}));return(await uni.saveFile({tempFilePath:e})).savedFilePath}catch(n){throw t("error","at pages/inProject/inProject.vue:382","保存图片时发生错误:",n),n}},async chooseImage(e){try{"android"!==uni.getSystemInfoSync().platform&&"ios"!==uni.getSystemInfoSync().platform||await new Promise(((e,t)=>{plus.io.resolveLocalFileSystemURL("_doc/",(n=>{n.getDirectory("images",{create:!0},(()=>{e()}),(e=>t(e)))}),(e=>t(e)))})).catch((e=>{throw t("error","at pages/inProject/inProject.vue:399","创建目录失败:",e),e}));const s=(await new Promise(((e,t)=>{uni.chooseImage({count:1,success:e,fail:t})}))).tempFilePaths[0];try{const t=await this.saveImageToLocal(s);if(e.id)await n.updateTableData("wall_data",`image='${t}'`,"id",e.id);else{const a=this.sections[this.currentIndex];await n.insertTableData("wall_data",`null,${this.id},'${a}','${e.name}','${e.slope||""}','${e.flatness||""}','${t}'`,"id,project_id,section,wall_name,slope,flatness,image")}e.image=t,uni.showToast({title:"图片保存成功",icon:"success"})}catch(a){t("error","at pages/inProject/inProject.vue:444","保存图片失败:",a),uni.showToast({title:"保存图片失败",icon:"none"})}}catch(a){t("error","at pages/inProject/inProject.vue:451","选择图片失败:",a),"chooseImage:fail cancel"!==a.errMsg&&uni.showToast({title:"选择图片失败",icon:"none"})}},async deleteWall(e){const a=this.sections[this.currentIndex],s=this.sectionData[a][e];uni.showModal({title:"确认删除",content:`是否确认删除${a}墙体${s.name}？`,success:async o=>{if(o.confirm)try{s.id&&await n.deleteTableData("wall_data",{id:s.id}),this.sectionData[a].splice(e,1),this.sectionData={...this.sectionData},uni.showToast({title:"删除成功",icon:"success"})}catch(i){t("error","at pages/inProject/inProject.vue:487","删除数据失败:",i),uni.showToast({title:"删除失败",icon:"none"})}}})},async initPageData(e={}){try{this.id=e.id||this.id,await this.getProject(),this.fullAddress=this.formatProjectTitle(this.project),await this.loadSections(),await this.loadWallData()}catch(n){t("error","at pages/inProject/inProject.vue:507","页面加载失败:",n),uni.showToast({title:"加载失败",icon:"none"})}},async refreshPageData(){try{await this.getProject(),this.fullAddress=this.formatProjectTitle(this.project),await this.loadWallData()}catch(e){t("error","at pages/inProject/inProject.vue:522","页面刷新失败:",e),uni.showToast({title:"刷新失败",icon:"none"})}},goToProjectEdit(e){t("log","at pages/inProject/inProject.vue:531","跳转编辑页面，项目ID:",e),uni.navigateTo({url:`/pages/inProject/edit/edit?id=${this.id}`,fail:e=>{t("error","at pages/inProject/inProject.vue:535","跳转失败:",e),uni.showToast({title:"跳转失败",icon:"none"})}})},getWalls(){const e=this.sections[this.currentIndex];return this.sectionData[e]||[]},addNewWall(){this.newWallName="",this.showNameInput=!0},async confirmAddWall(){const e=this.sections[this.currentIndex];let a=this.sectionData[e],s=this.newWallName.trim();if(s){if(a.some((e=>e.name===s)))return void uni.showToast({title:"墙体名称已存在",icon:"none"})}else s=this.getNextName(a);try{const t=["id","project_id","section","wall_name","slope","flatness","image"],o=["null",`'${this.id}'`,`'${e}'`,`'${s}'`,"''","''","''"];await n.insertTableData("wall_data",o.join(","),t.join(","));const i=await new Promise(((e,t)=>{plus.sqlite.selectSql({name:n.dbName,sql:"SELECT last_insert_rowid() as id",success:t=>{e(t)},fail:e=>{t(e)}})}));a.push({name:s,slope:"",flatness:"",image:"",id:i[0].id}),this.sectionData={...this.sectionData},this.showNameInput=!1,uni.showToast({title:"添加墙体成功",icon:"success"})}catch(o){t("error","at pages/inProject/inProject.vue:614","添加墙体失败:",o),uni.showToast({title:"添加墙体失败",icon:"none"})}},getNextName(e){if(!e||0===e.length)return"A";const t=e.map((e=>e.name));let n=0;return t.forEach((e=>{const t=(e=>{let t=0;for(let n=0;n<e.length;n++)t*=26,t+=e.charCodeAt(n)-64;return t})(e);t>n&&(n=t)})),(e=>{let t="";for(;e>0;){let n=(e-1)%26;t=String.fromCharCode(65+n)+t,e=Math.floor((e-1)/26)}return t})(n+1)},previewImage(e){e&&uni.previewImage({urls:[e],current:e,fail:e=>{t("error","at pages/inProject/inProject.vue:656","预览图片失败:",e),uni.showToast({title:"预览失败",icon:"none"})}})},async removeImage(e){try{const s=e.image;if(s)try{const e=uni.getSystemInfoSync().platform;"android"===e||"ios"===e?await new Promise(((e,n)=>{plus.io.resolveLocalFileSystemURL(s,(a=>{a.remove((()=>{t("log","at pages/inProject/inProject.vue:676","文件删除成功"),e()}),(e=>{t("warn","at pages/inProject/inProject.vue:679","文件删除失败:",e),n(e)}))}),(e=>{t("warn","at pages/inProject/inProject.vue:683","解析文件路径失败:",e),n(e)}))})):await uni.removeSavedFile({filePath:s})}catch(a){t("warn","at pages/inProject/inProject.vue:694","删除旧图片文件失败:",a)}e.id&&(await n.updateTableData("wall_data","image=''","id",e.id),e.image="",uni.showToast({title:"删除成功",icon:"success"}))}catch(s){t("error","at pages/inProject/inProject.vue:716","删除图片失败:",s),uni.showToast({title:"删除失败",icon:"none"})}},exportTable(){try{const e=p.generateCSVContent({projectInfo:this.project,warningSettings:this.warningSettings,showSlope:this.showSlope,showFlatness:this.showFlatness,isOverWarning:this.isOverWarning,sections:this.sections,sectionData:this.sectionData}),n={content:e,fileName:`${this.fullAddress}-墙体数据.csv`,projectInfo:{title:this.project.title||"",address:this.project.address||"",date:this.project.date||"",building:this.project.building||"",unit:this.project.unit||"",floor:this.project.floor||"",roomNumber:this.project.room_number||"",typeTag:this.project.type_tag||"",projectStatus:this.project.project_status||"",inspectionStatus:this.project.inspection_status||"",inspector:this.project.inspector||""},warningSettings:this.warningSettings,createTime:(new Date).toLocaleString()},a=encodeURIComponent(JSON.stringify(n));uni.navigateTo({url:`/pages/newProject/csv/preview/preview?data=${a}`,fail:e=>{t("error","at pages/inProject/inProject.vue:763","跳转预览页面失败:",e),uni.showToast({title:"跳转失败",icon:"none"})}})}catch(e){t("error","at pages/inProject/inProject.vue:771","导出失败:",e),uni.showToast({title:"导出失败",icon:"none"})}},async getProject(){try{const e=await n.selectTableData("project",{id:this.id});e&&e.length>0?(this.project=e[0],this.projectType=e[0].project_status,this.$nextTick((()=>{this.fullAddress=this.formatProjectTitle(this.project)}))):uni.showToast({title:"未找到该项目",icon:"none"})}catch(e){t("error","at pages/inProject/inProject.vue:792","查询失败",e),uni.showToast({title:"查询出错",icon:"none"})}},formatProjectTitle(e){if(!e)return"";let t=e.title||"";return e.building&&(t+="-"+e.building),e.unit&&(t+="-"+e.unit+"栋"),e.floor&&(t+="-"+e.floor),e.room_number&&(t+="-"+e.room_number),t},convertToCSV(){return p.generateCSVContent({projectInfo:this.project,warningSettings:this.warningSettings,showSlope:this.showSlope,showFlatness:this.showFlatness,isOverWarning:this.isOverWarning,sections:this.sections,sectionData:this.sectionData})},generateCurrentCSVContent(){return p.generateCSVContent({projectInfo:this.project,warningSettings:this.warningSettings,showSlope:this.showSlope,showFlatness:this.showFlatness,isOverWarning:this.isOverWarning,sections:this.sections,sectionData:this.sectionData})},async beforeDestroy(){this.pendingSave&&await this.autoSave()},async initSettingsTable(){try{await n.createTable("warning_settings",'\n          "id" INTEGER PRIMARY KEY AUTOINCREMENT,\n          "project_id" INTEGER NOT NULL,\n          "slope_warning" REAL,\n          "flatness_warning" REAL,\n          "image" TEXT,\n          FOREIGN KEY(project_id) REFERENCES project(id)\n        '),t("log","at pages/inProject/inProject.vue:861","预警设置表创建成功"),await this.loadSettings()}catch(e){t("error","at pages/inProject/inProject.vue:864","创建预警设置表失败:",e)}},async loadSettings(){var e,a;try{const t=await n.selectTableData("warning_settings",{project_id:this.id});t&&t.length>0&&(this.warningSettings={slopeWarning:(null==(e=t[0].slope_warning)?void 0:e.toString())||"",flatnessWarning:(null==(a=t[0].flatness_warning)?void 0:a.toString())||""})}catch(s){t("error","at pages/inProject/inProject.vue:878","加载预警设置失败:",s)}},async saveSettings(){try{const e=await n.selectTableData("warning_settings",{project_id:this.id}),t={slope_warning:parseFloat(this.warningSettings.slopeWarning),flatness_warning:parseFloat(this.warningSettings.flatnessWarning)};t.slope_warning=isNaN(t.slope_warning)?null:t.slope_warning,t.flatness_warning=isNaN(t.flatness_warning)?null:t.flatness_warning,e&&e.length>0?await n.updateTableData("warning_settings",`slope_warning=${t.slope_warning},flatness_warning=${t.flatness_warning}`,"project_id",this.id):await n.insertTableData("warning_settings",`null,${this.id},${t.slope_warning},${t.flatness_warning}`,"id,project_id,slope_warning,flatness_warning"),this.showSettings=!1,uni.showToast({title:"设置已保存",icon:"success"})}catch(e){t("error","at pages/inProject/inProject.vue:914","保存设置失败:",e),uni.showToast({title:"保存失败",icon:"none"})}},handleSettingInput(e,t){this.warningSettings[e]=t},isOverWarning(e,t){if(!e||!this.warningSettings[t+"Warning"])return!1;const n=parseFloat(e),a=parseFloat(this.warningSettings[t+"Warning"]);return Math.abs(n)>a},async initSectionTable(){try{await n.createTable("sections",'\n          "id" INTEGER PRIMARY KEY AUTOINCREMENT,\n          "project_id" INTEGER NOT NULL,\n          "name" TEXT NOT NULL,\n          "sort_order" INTEGER,\n          FOREIGN KEY(project_id) REFERENCES project(id)\n        '),t("log","at pages/inProject/inProject.vue:943","房间表创建成功"),await this.loadSections()}catch(e){t("error","at pages/inProject/inProject.vue:946","创建房间表失败:",e)}},async loadSections(){try{const e=await n.selectTableData("sections",{project_id:this.id});e&&e.length>0?this.sections=e.sort(((e,t)=>e.sort_order-t.sort_order)).map((e=>e.name)):this.sections=[],this.sections.forEach((e=>{this.sectionData[e]||(this.sectionData[e]=[])}))}catch(e){t("error","at pages/inProject/inProject.vue:968","加载房间数据失败:",e)}},addNewSection(){this.isEditingSection=!1,this.newSectionName="",this.showSectionInput=!0},editSection(e){this.isEditingSection=!0,this.editingSectionOldName=e,this.newSectionName=e,this.showSectionInput=!0},async confirmSection(){try{const e=this.newSectionName.trim();if(!e)return void uni.showToast({title:"房间名称不能为空",icon:"none"});if(this.isEditingSection){const t=this.sectionData[this.editingSectionOldName];delete this.sectionData[this.editingSectionOldName],this.sectionData[e]=t||[],await n.updateTableData("sections",`name='${e}'`,"name",this.editingSectionOldName),await n.updateTableData("wall_data",`section='${e}'`,"section",this.editingSectionOldName);const a=this.sections.indexOf(this.editingSectionOldName);-1!==a&&(this.sections[a]=e)}else{const t=this.sections.length;await n.insertTableData("sections",`null,${this.id},'${e}',${t}`,"id,project_id,name,sort_order"),this.sections.push(e),this.sectionData[e]=[]}this.showSectionInput=!1,uni.showToast({title:this.isEditingSection?"修改成功":"添加成功",icon:"success"})}catch(e){t("error","at pages/inProject/inProject.vue:1044","操作房间失败:",e),uni.showToast({title:"操作失败",icon:"none"})}},async deleteSection(e){uni.showModal({title:"确认删除",content:`是否确认删除房间"${e}"？删除后该房间的所有墙体数据都将被删除！`,success:async a=>{if(a.confirm)try{await n.deleteTableData("wall_data",{section:e}),await n.deleteTableData("sections",{name:e});const t=this.sections.indexOf(e);-1!==t&&(this.sections.splice(t,1),delete this.sectionData[e],this.currentIndex===t?this.currentIndex=0:this.currentIndex>t&&this.currentIndex--),uni.showToast({title:"删除成功",icon:"success"})}catch(s){t("error","at pages/inProject/inProject.vue:1085","删除房间失败:",s),uni.showToast({title:"删除失败",icon:"none"})}}})}},onLoad(e){t("log","at pages/inProject/inProject.vue:1097","onLoad options:",e),this.initPageData(e)},onShow(){t("log","at pages/inProject/inProject.vue:1103","onShow with id:",this.id),this.id&&this.refreshPageData()}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"room-header",onClick:n[0]||(n[0]=e=>i.goToProjectEdit(o.id))},[e.createTextVNode(e.toDisplayString(o.fullAddress)+" ",1),e.createElementVNode("image",{src:"/static/image/edit.png",class:"edit-icon",mode:"aspectFit"})]),e.createElementVNode("scroll-view",{"scroll-y":"",class:"left-panel"},[e.createElementVNode("view",{class:"add-section-btn",onClick:n[1]||(n[1]=(...e)=>i.addNewSection&&i.addNewSection(...e))},"+ 添加房间"),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.sections,((t,n)=>(e.openBlock(),e.createElementBlock("view",{key:n,class:e.normalizeClass(["menu-item",o.currentIndex===n?"active":""])},[e.createElementVNode("view",{class:"menu-item-content",onClick:e=>o.currentIndex=n},e.toDisplayString(t),9,["onClick"]),e.createElementVNode("view",{class:"menu-item-actions"},[e.createElementVNode("text",{class:"action-btn edit",onClick:e.withModifiers((e=>i.editSection(t)),["stop"])},"✏️",8,["onClick"]),e.createElementVNode("text",{class:"action-btn delete",onClick:e.withModifiers((e=>i.deleteSection(t)),["stop"])},"×",8,["onClick"])])],2)))),128))]),e.createElementVNode("view",{class:"right-panel"},[e.createElementVNode("view",{class:"spacer"}),e.createElementVNode("scroll-view",{"scroll-y":"",class:"content-scroll"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(i.getWalls(),((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"wall-card",key:n},[e.createElementVNode("view",{class:"wall-title"},"墙体 "+e.toDisplayString(t.name),1),e.createElementVNode("view",{class:"data-row"},[i.showSlope?(e.openBlock(),e.createElementBlock("view",{key:0,class:"row"},[e.createElementVNode("text",{class:"label"},"坡度↔"),e.createElementVNode("view",{class:"input-unit-wrapper"},[e.createElementVNode("input",{class:e.normalizeClass(["input",i.isOverWarning(t.slope,"slope")?"warning":""]),value:t.slope,onInput:e=>i.handleInput(t,"slope",e.detail.value),placeholder:"请输入坡度"},null,42,["value","onInput"]),e.createElementVNode("text",{class:"unit"},"mm/M")])])):e.createCommentVNode("",!0),i.showFlatness?(e.openBlock(),e.createElementBlock("view",{key:1,class:"row"},[e.createElementVNode("text",{class:"label"},"平整度"),e.createElementVNode("view",{class:"input-unit-wrapper"},[e.createElementVNode("input",{class:e.normalizeClass(["input",i.isOverWarning(t.flatness,"flatness")?"warning":""]),value:t.flatness,onInput:e=>i.handleInput(t,"flatness",e.detail.value),placeholder:"请输入平整度"},null,42,["value","onInput"]),e.createElementVNode("text",{class:"unit"},"mm")])])):e.createCommentVNode("",!0),t.image?(e.openBlock(),e.createElementBlock("view",{key:2,class:"row-image"},[e.createElementVNode("view",{class:"image-wrapper"},[e.createElementVNode("image",{class:"image",mode:"aspectFill",src:t.image,onClick:e=>i.previewImage(t.image)},null,8,["src","onClick"]),e.createElementVNode("view",{class:"delete-icon",onClick:e.withModifiers((e=>i.removeImage(t)),["stop"])},"×",8,["onClick"])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"row actions"},[e.createElementVNode("button",{onClick:e=>i.chooseImage(t)},"添加照片",8,["onClick"]),e.createElementVNode("button",{onClick:e=>i.deleteWall(n)},"删除墙体",8,["onClick"])])])])))),128)),e.createElementVNode("view",{class:"add-wall-btn",onClick:n[2]||(n[2]=(...e)=>i.addNewWall&&i.addNewWall(...e))}," + 添加新墙体 ")]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{onClick:n[3]||(n[3]=(...e)=>i.exportTable&&i.exportTable(...e))},"导出表格"),e.createElementVNode("button",{onClick:n[4]||(n[4]=e=>o.showSettings=!0),class:"settings-btn"},[e.createElementVNode("image",{src:"/static/image/config.png",class:"settings-icon",mode:"aspectFit"})])])]),o.showNameInput?(e.openBlock(),e.createElementBlock("view",{key:0,class:"custom-popup"},[e.createElementVNode("view",{class:"popup-mask",onClick:n[5]||(n[5]=e=>o.showNameInput=!1)}),e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-title"},"新增墙体"),e.createElementVNode("view",{class:"popup-input-wrap"},[e.withDirectives(e.createElementVNode("input",{class:"popup-input","onUpdate:modelValue":n[6]||(n[6]=e=>o.newWallName=e),placeholder:"请输入墙体名称（留空则自动命名）","placeholder-class":"input-placeholder"},null,512),[[e.vModelText,o.newWallName]])]),e.createElementVNode("view",{class:"popup-buttons"},[e.createElementVNode("button",{class:"popup-btn cancel",onClick:n[7]||(n[7]=e=>o.showNameInput=!1)},"取消"),e.createElementVNode("button",{class:"popup-btn confirm",onClick:n[8]||(n[8]=(...e)=>i.confirmAddWall&&i.confirmAddWall(...e))},"确定")])])])):e.createCommentVNode("",!0),o.showSettings?(e.openBlock(),e.createElementBlock("view",{key:1,class:"custom-popup"},[e.createElementVNode("view",{class:"popup-mask",onClick:n[9]||(n[9]=e=>o.showSettings=!1)}),e.createElementVNode("view",{class:"popup-content settings-popup"},[e.createElementVNode("view",{class:"popup-title"},"预警值设置"),e.createElementVNode("view",{class:"settings-form"},[i.showSlope?(e.openBlock(),e.createElementBlock("view",{key:0,class:"setting-item"},[e.createElementVNode("text",{class:"setting-label"},"坡度预警值 (mm/M)"),e.createElementVNode("input",{type:"digit",class:"setting-input",value:o.warningSettings.slopeWarning,onInput:n[10]||(n[10]=e=>i.handleSettingInput("slopeWarning",e.detail.value)),placeholder:"请输入坡度预警值"},null,40,["value"])])):e.createCommentVNode("",!0),i.showFlatness?(e.openBlock(),e.createElementBlock("view",{key:1,class:"setting-item"},[e.createElementVNode("text",{class:"setting-label"},"平整度预警值 (mm)"),e.createElementVNode("input",{type:"digit",class:"setting-input",value:o.warningSettings.flatnessWarning,onInput:n[11]||(n[11]=e=>i.handleSettingInput("flatnessWarning",e.detail.value)),placeholder:"请输入平整度预警值"},null,40,["value"])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"popup-buttons"},[e.createElementVNode("button",{class:"popup-btn cancel",onClick:n[12]||(n[12]=e=>o.showSettings=!1)},"取消"),e.createElementVNode("button",{class:"popup-btn confirm",onClick:n[13]||(n[13]=(...e)=>i.saveSettings&&i.saveSettings(...e))},"确定")])])])):e.createCommentVNode("",!0),o.showSectionInput?(e.openBlock(),e.createElementBlock("view",{key:2,class:"custom-popup"},[e.createElementVNode("view",{class:"popup-mask",onClick:n[14]||(n[14]=e=>o.showSectionInput=!1)}),e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-title"},e.toDisplayString(o.isEditingSection?"编辑房间":"新增房间"),1),e.createElementVNode("view",{class:"popup-input-wrap"},[e.withDirectives(e.createElementVNode("input",{class:"popup-input","onUpdate:modelValue":n[15]||(n[15]=e=>o.newSectionName=e),placeholder:o.isEditingSection?"请输入新的房间名称":"请输入房间名称","placeholder-class":"input-placeholder"},null,8,["placeholder"]),[[e.vModelText,o.newSectionName]])]),e.createElementVNode("view",{class:"popup-buttons"},[e.createElementVNode("button",{class:"popup-btn cancel",onClick:n[16]||(n[16]=e=>o.showSectionInput=!1)},"取消"),e.createElementVNode("button",{class:"popup-btn confirm",onClick:n[17]||(n[17]=(...e)=>i.confirmSection&&i.confirmSection(...e))},"确定")])])])):e.createCommentVNode("",!0)])}],["__scopeId","data-v-ac3f0b7b"]]);const m=o({data:()=>({listData:[]}),onLoad(){this.openSQL()},methods:{openSQL(){let e=n.isOpen();t("log","at pages/test/test.vue:37","数据库状态",e?"开启":"关闭"),e||n.openSqlite().then((e=>{t("log","at pages/test/test.vue:41","数据库已打开")})).catch((e=>{t("log","at pages/test/test.vue:44","数据库开启失败")}))},closeSQL(){n.isOpen()&&n.closeSqlite().then((e=>{t("log","at pages/test/test.vue:56","数据库已关闭")})).catch((e=>{t("log","at pages/test/test.vue:59","数据库关闭失败")}))},createTable(){if(n.isOpen()){this.openSQL();let e='"id" INTEGER PRIMARY KEY AUTOINCREMENT,"icon" TEXT NOT NULL,"title" TEXT NOT NULL,"address" TEXT,"date" TEXT NOT NULL,"type_tag" TEXT,"building" TEXT,"unit" TEXT,"floor" TEXT,"room_number" TEXT,"inspector" TEXT,"project_status" TEXT,"inspection_status" TEXT';n.createTable("project",e).then((e=>{t("log","at pages/test/test.vue:74","创建project表成功")})).catch((e=>{t("log","at pages/test/test.vue:77","创建表失败")}))}else t("log","at pages/test/test.vue:80","数据库未打开")},insertTableData(){if(n.isOpen()){let e=["icon","title","address","date","type_tag","building","unit","floor","room_number","inspector","project_status","inspection_status"];[{icon:"/static/image/home1.png",title:"衡阳项目",address:"湖南省衡阳市蒸湘区蔡伦大道",date:"2023-08-01",type_tag:"校园",building:"A栋",unit:"2单元",floor:"6层",room_number:"A603",inspector:"张工",project_status:"进行中",inspection_status:"未验收"},{icon:"/static/image/home1.png",title:"衡阳项目",address:"湖南省衡阳市蒸湘区蔡伦大道",date:"2023-08-01",type_tag:"校园",building:"A栋",unit:"2单元",floor:"6层",room_number:"A603",inspector:"张工",project_status:"进行中",inspection_status:"未验收"},{icon:"/static/image/home1.png",title:"衡阳项目",address:"湖南省衡阳市蒸湘区蔡伦大道",date:"2023-08-01",type_tag:"校园",building:"A栋",unit:"2单元",floor:"6层",room_number:"A603",inspector:"张工",project_status:"进行中",inspection_status:"未验收"},{icon:"/static/image/home1.png",title:"衡阳项目",address:"湖南省衡阳市蒸湘区蔡伦大道",date:"2023-08-01",type_tag:"校园",building:"A栋",unit:"2单元",floor:"6层",room_number:"A603",inspector:"张工",project_status:"进行中",inspection_status:"未验收"},{icon:"/static/image/home1.png",title:"衡阳项目",address:"湖南省衡阳市蒸湘区蔡伦大道",date:"2023-08-01",type_tag:"校园",building:"A栋",unit:"2单元",floor:"6层",room_number:"A603",inspector:"张工",project_status:"进行中",inspection_status:"未验收"},{icon:"/static/image/home1.png",title:"衡阳项目",address:"湖南省衡阳市蒸湘区蔡伦大道",date:"2023-08-01",type_tag:"校园",building:"A栋",unit:"2单元",floor:"6层",room_number:"A603",inspector:"张工",project_status:"进行中",inspection_status:"未验收"}].map((a=>{let s=`'${a.icon}','${a.title}','${a.address}','${a.date}','${a.type_tag}','${a.building}','${a.unit}','${a.floor}','${a.room_number}','${a.inspector}','${a.project_status}','${a.inspection_status}'`;n.insertTableData("project",s,e).then((e=>{t("log","at pages/test/test.vue:179","新增数据成功"),this.selectTableData()})).catch((e=>{t("log","at pages/test/test.vue:183","失败",e)}))}))}else this.showToast("数据库未打开")},selectTableData(){n.isOpen()?n.selectTableData("project").then((e=>{t("log","at pages/test/test.vue:197","contact表数据",e),this.listData=e})).catch((e=>{t("log","at pages/test/test.vue:201","查询失败",e)})):this.showToast("数据库未打开")},updateTableData(){if(n.isOpen()){let e=`content = '我被修改了',time = '${this.formatDate((new Date).getTime())}'`;n.updateTableData("chat",e,"name","小明").then((e=>{this.showToast("更新chat表成功"),this.selectTableData()})).catch((e=>{t("log","at pages/test/test.vue:220","修改失败",e)}))}else this.showToast("数据库未打开")},deleteTable(){n.isOpen()?n.deleteTable("project").then((e=>{this.showToast("删除表成功")})).catch((e=>{t("log","at pages/test/test.vue:235","删除表失败",e)})):this.showToast("数据库未打开")},deleteTableData(){n.isOpen()?n.deleteTableData("chat","name","小红").then((e=>{this.showToast("删除表数据成功"),this.selectTableData()})).catch((e=>{t("log","at pages/test/test.vue:253","删除失败",e)})):this.showToast("数据库未打开")},showToast:function(e){uni.showToast({icon:"none",title:e,mask:!0})},formatDate(e){let t=new Date(e);return t.getFullYear()+"-"+(t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1)+"-"+(t.getDate()<10?"0"+t.getDate():t.getDate())+" "+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+":"+(t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds())}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",null,[e.createElementVNode("view",{class:"uni-divider uni-divider__content"},"Demo"),e.createElementVNode("button",{onClick:n[0]||(n[0]=(...e)=>i.openSQL&&i.openSQL(...e))},"打开数据库"),e.createElementVNode("button",{onClick:n[1]||(n[1]=(...e)=>i.createTable&&i.createTable(...e))},"创建表"),e.createElementVNode("button",{onClick:n[2]||(n[2]=(...e)=>i.insertTableData&&i.insertTableData(...e))},"新增表数据"),e.createElementVNode("button",{onClick:n[3]||(n[3]=(...e)=>i.selectTableData&&i.selectTableData(...e))},"查询表数据"),e.createElementVNode("button",{onClick:n[4]||(n[4]=(...e)=>i.updateTableData&&i.updateTableData(...e))},"修改表数据"),e.createElementVNode("button",{onClick:n[5]||(n[5]=(...e)=>i.deleteTableData&&i.deleteTableData(...e))},"按条件删除表数据"),e.createElementVNode("button",{onClick:n[6]||(n[6]=(...e)=>i.closeSQL&&i.closeSQL(...e))},"关闭数据库"),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.listData,((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"uni-divider__content",key:n},[e.createElementVNode("view",null,"名字:"+e.toDisplayString(t.title),1),e.createElementVNode("view",null,"内容:"+e.toDisplayString(t.address),1),e.createElementVNode("view",null,"时间:"+e.toDisplayString(t.date),1)])))),128))])}]]);const u=o({data:()=>({typeOptions:[{name:"学校",icon:"/static/image/home1.png"},{name:"办公楼",icon:"/static/image/home2.png"},{name:"工业厂房",icon:"/static/image/home3.png"},{name:"公寓小区",icon:"/static/image/home4.png"},{name:"乡镇住宅",icon:"/static/image/home5.png"},{name:"其他",icon:"/static/image/home6.png"}],packageOptions:["坡度","平整度","坡度加平整度"],inspectionStatusOptions:["未验收","已验收"],projectFields:[{key:"title",label:"项目名称"},{key:"address",label:"项目地址"},{key:"date",label:"验收日期"},{key:"building",label:"栋"},{key:"unit",label:"单元"},{key:"floor",label:"楼层"},{key:"room_number",label:"房号"},{key:"inspector",label:"质检员"}],form:{icon:"/static/image/home1.png",type_tag:"",title:"",address:"",date:(new Date).toISOString().split("T")[0],building:"",unit:"",floor:"",room_number:"",inspector:"",project_status:"坡度加平整度",inspection_status:"未验收"}}),methods:{onTypeSelect(e){const t=this.typeOptions[e];this.form.type_tag=t.name,this.form.icon=t.icon},onDateChange(e){this.form.date=e.detail.value},onPackageChange(e){this.form.project_status=this.packageOptions[e.detail.value]},onInspectionStatusChange(e){this.form.inspection_status=this.inspectionStatusOptions[e.detail.value]},submit(){if(!this.form.title.trim())return void uni.showToast({title:"请输入项目名称",icon:"none"});if(!this.form.address.trim())return void uni.showToast({title:"请输入项目地址",icon:"none"});if(!this.form.date.trim())return void uni.showToast({title:"请输入验收日期",icon:"none"});const e=`INSERT INTO project (\n\t\t\t\ticon, title, address, date, type_tag,\n\t\t\t\tbuilding, unit, floor, room_number, inspector,\n\t\t\t\tproject_status, inspection_status\n\t\t\t) VALUES (${[this.form.icon,this.form.title,this.form.address,this.form.date,this.form.type_tag,this.form.building,this.form.unit,this.form.floor,this.form.room_number,this.form.inspector,this.form.project_status,this.form.inspection_status].map((e=>`'${e}'`)).join(", ")})`;n.isOpen()?this.insertProject(e):n.openSqlite().then((()=>this.insertProject(e)))},insertProject(e){plus.sqlite.executeSql({name:n.dbName,sql:e,success:()=>{t("log","at pages/newProject/template/template.vue:170","插入成功"),uni.showToast({title:"添加成功",icon:"success"}),setTimeout((()=>uni.navigateBack()),1e3)},fail:e=>{t("error","at pages/newProject/template/template.vue:175","插入失败",e),uni.showToast({title:"添加失败",icon:"none"})}})},async getLocation(){const e=this;uni.getLocation({type:"wgs84",success(t){uni.request({url:`https://apis.map.qq.com/ws/geocoder/v1/?location=${t.latitude},${t.longitude}&key=GN4BZ-LSR64-7DAUI-DB246-CUPM3-5HBMM`,success(t){if(t.data&&t.data.result){const n=t.data.result.formatted_addresses&&t.data.result.formatted_addresses.standard_address||t.data.result.address;e.form.address=n}else uni.showToast({title:"定位失败",icon:"none"})},fail(){uni.showToast({title:"定位失败",icon:"none"})}})},fail(){uni.showToast({title:"获取定位失败",icon:"none"})}})}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"main"},[e.createElementVNode("scroll-view",{"scroll-y":"true",class:"scroll-view"},[e.createElementVNode("view",{class:"container"},[e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"form-title"},"项目信息"),e.createElementVNode("view",{class:"form-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.projectFields,(t=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["form-item",{"full-width":"address"===t.key||"title"===t.key}]),key:t.key},["address"===t.key?(e.openBlock(),e.createElementBlock("view",{key:0,class:"label-with-button"},[e.createElementVNode("text",{class:"label"},e.toDisplayString(t.label),1),e.createElementVNode("button",{class:"location-btn",type:"default",size:"mini",onClick:n[0]||(n[0]=(...e)=>i.getLocation&&i.getLocation(...e))},[e.createElementVNode("text",{class:"location-text"},"获取定位")])])):(e.openBlock(),e.createElementBlock("text",{key:1,class:"label"},e.toDisplayString(t.label),1)),"address"===t.key?(e.openBlock(),e.createElementBlock("view",{key:2,class:"address-container"},[e.withDirectives(e.createElementVNode("input",{class:"input address-input","onUpdate:modelValue":e=>o.form[t.key]=e,placeholder:"请输入"+t.label},null,8,["onUpdate:modelValue","placeholder"]),[[e.vModelText,o.form[t.key]]])])):"date"===t.key?(e.openBlock(),e.createElementBlock("picker",{key:3,mode:"date",value:o.form[t.key],onChange:n[1]||(n[1]=(...e)=>i.onDateChange&&i.onDateChange(...e))},[e.createElementVNode("view",{class:"picker-view"},e.toDisplayString(o.form[t.key]||"请选择"+t.label),1)],40,["value"])):e.withDirectives((e.openBlock(),e.createElementBlock("input",{key:4,class:"input","onUpdate:modelValue":e=>o.form[t.key]=e,placeholder:"请输入"+t.label},null,8,["onUpdate:modelValue","placeholder"])),[[e.vModelText,o.form[t.key]]])],2)))),128))])]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"form-title"},"项目类型"),e.createElementVNode("view",{class:"type-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.typeOptions,((t,n)=>(e.openBlock(),e.createElementBlock("view",{key:t.name,class:e.normalizeClass(["type-item",{active:o.form.type_tag===t.name}]),onClick:e=>i.onTypeSelect(n)},[e.createElementVNode("image",{src:t.icon,class:"type-icon",mode:"aspectFit"},null,8,["src"]),e.createElementVNode("text",{class:"type-name"},e.toDisplayString(t.name),1)],10,["onClick"])))),128))])]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"form-title"},"状态信息"),e.createElementVNode("view",{class:"form-grid"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"label"},"验收类型"),e.createElementVNode("picker",{range:o.packageOptions,onChange:n[2]||(n[2]=(...e)=>i.onPackageChange&&i.onPackageChange(...e))},[e.createElementVNode("view",{class:"picker-view"},e.toDisplayString(o.form.project_status||"请选择验收类型"),1)],40,["range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"label"},"验收状态"),e.createElementVNode("picker",{range:o.inspectionStatusOptions,onChange:n[3]||(n[3]=(...e)=>i.onInspectionStatusChange&&i.onInspectionStatusChange(...e))},[e.createElementVNode("view",{class:"picker-view"},e.toDisplayString(o.form.inspection_status||"请选择验收状态"),1)],40,["range"])])])])])]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"submit-btn",onClick:n[4]||(n[4]=(...e)=>i.submit&&i.submit(...e))},"提交项目")])])}]]);const h=o({data:()=>({selectedFile:null,headers:["房间","墙体","坡度(mm/M)","平整度(mm)","预警状态"],previewData:[],projectInfo:{title:"",address:"",date:"",building:"",unit:"",floor:"",roomNumber:"",type:"",inspectionType:"",inspectionStatus:"",inspector:"",icon:"/static/image/home1.png"},typeOptions:[{name:"学校",icon:"/static/image/home1.png"},{name:"办公楼",icon:"/static/image/home2.png"},{name:"工业厂房",icon:"/static/image/home3.png"},{name:"公寓小区",icon:"/static/image/home4.png"},{name:"乡镇住宅",icon:"/static/image/home5.png"},{name:"其他",icon:"/static/image/home6.png"}],projectTypes:["学校","办公楼","工业厂房","住宅小区","别墅"],inspectionTypes:["坡度","平整度","坡度加平整度"],importInProgress:!1,allData:[],warningSettings:{slopeWarning:"",flatnessWarning:""}}),computed:{canImport(){return this.previewData.length>0&&this.projectInfo.title&&this.projectInfo.address&&this.projectInfo.type&&this.projectInfo.inspectionType&&!this.importInProgress}},methods:{formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]},showInspectionTypeEditTip(){uni.showToast({title:"如需修改验收类型，请到项目编辑页面进行修改",icon:"none",duration:3e3})},chooseFile(){if("undefined"!=typeof plus)try{const e=plus.android.runtimeMainActivity(),n=plus.android.importClass("android.content.Intent"),a=new n(n.ACTION_GET_CONTENT);a.addCategory(n.CATEGORY_OPENABLE),a.setType("text/comma-separated-values"),e.onActivityResult=(n,a,s)=>{if(1===n&&-1===a)try{const n=s.getData(),a=n.toString();let i="unknown.csv";if(-1!==a.lastIndexOf("/")){i=a.substring(a.lastIndexOf("/")+1);try{i=decodeURIComponent(i)}catch(o){t("error","at pages/newProject/csv/csv.vue:243","解码文件名失败:",o)}}if(!i.toLowerCase().endsWith(".csv"))return void uni.showToast({title:"请选择CSV文件",icon:"none"});plus.android.importClass("java.io.InputStream");const l=plus.android.importClass("java.io.InputStreamReader"),c=plus.android.importClass("java.io.BufferedReader"),r=plus.android.importClass("java.lang.StringBuilder"),p=plus.android.invoke(e.getContentResolver(),"openInputStream",n),d=new l(p,"UTF-8"),m=new c(d),u=new r;let h=null;try{for(;null!=(h=m.readLine());)u.append(h).append("\n")}finally{try{m.close()}catch(o){t("error","at pages/newProject/csv/csv.vue:276","关闭BufferedReader失败:",o)}try{d.close()}catch(o){t("error","at pages/newProject/csv/csv.vue:277","关闭InputStreamReader失败:",o)}try{p.close()}catch(o){t("error","at pages/newProject/csv/csv.vue:278","关闭InputStream失败:",o)}}const g=u.toString();this.selectedFile={name:i,path:a,size:g.length},this.parseCSV(g)}catch(i){t("error","at pages/newProject/csv/csv.vue:294","读取文件失败:",i),uni.showToast({title:"读取文件失败",icon:"none"})}},e.startActivityForResult(a,1)}catch(e){t("error","at pages/newProject/csv/csv.vue:307","启动文件选择器失败:",e),uni.showToast({title:"无法打开文件选择器",icon:"none"})}else uni.chooseFile({count:1,extension:[".csv"],success:e=>{const t=e.tempFiles[0];this.selectedFile={name:t.name,size:t.size,path:t.path},this.readCSVFile(t)},fail:e=>{"chooseFile:fail cancel"!==e.errMsg&&uni.showToast({title:"选择文件失败",icon:"none"})}})},readCSVFile(e){if("undefined"!=typeof plus)e.file?e.file((e=>{const n=new plus.io.FileReader;n.onloadend=e=>{e.target.result?this.parseCSV(e.target.result):uni.showToast({title:"文件内容为空",icon:"none"})},n.onerror=e=>{t("error","at pages/newProject/csv/csv.vue:355","读取文件失败:",e),uni.showToast({title:"读取文件失败",icon:"none"})},n.readAsText(e,"utf-8")}),(e=>{t("error","at pages/newProject/csv/csv.vue:363","获取文件对象失败:",e),uni.showToast({title:"无法读取文件",icon:"none"})})):plus.io.resolveLocalFileSystemURL(e.path||e,(e=>{e.file((e=>{const n=new plus.io.FileReader;n.onloadend=e=>{e.target.result?this.parseCSV(e.target.result):uni.showToast({title:"文件内容为空",icon:"none"})},n.onerror=e=>{t("error","at pages/newProject/csv/csv.vue:384","读取文件失败:",e),uni.showToast({title:"读取文件失败",icon:"none"})},n.readAsText(e,"utf-8")}))}));else{const n=new FileReader;n.onload=e=>{this.parseCSV(e.target.result)},n.onerror=e=>{t("error","at pages/newProject/csv/csv.vue:401","读取文件失败:",e),uni.showToast({title:"读取文件失败",icon:"none"})},n.readAsText(e)}},parseCSV(e){try{const t=(e=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n")).split("\n").map((e=>e.trim())).filter((e=>e)),n=t[0].split(",").map((e=>e.trim())),a=t[1].split(",").map((e=>e.trim().replace(/^"(.*)"$/,"$1"))),s={};n.forEach(((e,t)=>{s[e]=a[t]||""}));const o=t[2].match(/坡度预警值\(mm\/M\)：(\d+\.?\d*).*平整度预警值\(mm\)：(\d+\.?\d*)/);o&&(this.warningSettings={slopeWarning:o[1],flatnessWarning:o[2]}),this.projectInfo={title:s["项目名称"]||"",address:s["项目地址"]||"",date:s["验收日期"]||"",building:s["栋"]||"",unit:s["单元"]||"",floor:s["楼层"]||"",roomNumber:s["房号"]||"",type:s["项目类型"]||"",inspectionType:s["验收类型"]||"",inspectionStatus:s["验收状态"]||"",inspector:s["项目质检员"]||"",icon:s["项目图标"]||"/static/image/home1.png"};const i=t.slice(3),l=i[0].split(",").map((e=>e.trim())),c=["房间"];if(!this.validateHeaders(l,c))return void uni.showToast({title:"CSV格式不正确：缺少必需的房间列",icon:"none"});const r=i.slice(1).filter((e=>{const t=e.split(",").map((e=>e.trim().replace(/^"(.*)"$/,"$1")));return t[0]&&t[0].length>0})).map((e=>{const t=e.split(",").map((e=>e.trim().replace(/^"(.*)"$/,"$1"))),n=l.indexOf("房间"),a=l.indexOf("墙体"),s=l.indexOf("坡度(mm/M)"),o=l.indexOf("平整度(mm)");return[t[n>-1?n:0]||"",t[a>-1?a:1]||"",t[s>-1?s:2]||"",t[o>-1?o:3]||""]}));if(0===r.length)return void uni.showToast({title:"没有有效的数据行",icon:"none"});this.allData=r,this.updateHeadersBasedOnInspectionType(),this.previewData.length>0&&uni.showToast({title:"文件读取成功",icon:"success"})}catch(n){t("error","at pages/newProject/csv/csv.vue:516","解析CSV失败:",n),uni.showToast({title:"解析文件失败",icon:"none"})}},parseCSVContent(e){try{const t=p.parseCSVContent(e);if(!t)return uni.showToast({title:"解析CSV内容失败",icon:"none"}),!1;const n={"项目名称":"title","项目地址":"address","验收日期":"date","栋":"building","单元":"unit","楼层":"floor","房号":"roomNumber","项目类型":"type","验收类型":"inspectionType","验收状态":"inspectionStatus","项目质检员":"inspector"};if(t.projectInfo){const e={title:"",address:"",date:"",building:"",unit:"",floor:"",roomNumber:"",type:"",inspectionType:"",inspectionStatus:"",inspector:""};Object.keys(t.projectInfo).forEach((a=>{const s=n[a];s&&(e[s]=t.projectInfo[a]||"")})),this.projectInfo=e}t.warningSettings&&(this.warningSettings={slopeWarning:t.warningSettings.slopeWarning||"",flatnessWarning:t.warningSettings.flatnessWarning||""});if(!["房间","区域"].some((e=>t.headers.includes(e))))return uni.showToast({title:"CSV格式不正确，缺少必要的房间/区域列",icon:"none"}),!1;const a=t.headers.findIndex((e=>"房间"===e||"区域"===e)),s=t.headers.findIndex((e=>"墙体"===e)),o=t.headers.findIndex((e=>"坡度(mm/M)"===e||"坡度"===e)),i=t.headers.findIndex((e=>"平整度(mm)"===e||"平整度"===e));return this.allData=t.tableData.filter((e=>e[a]&&e[a].length>0)).map((e=>[e[a]||"",s>-1&&e[s]||"",o>-1&&e[o]||"",i>-1&&e[i]||""])),this.updateHeadersBasedOnInspectionType(),!0}catch(n){return t("error","at pages/newProject/csv/csv.vue:624","解析CSV内容失败:",n),uni.showToast({title:"解析CSV内容失败",icon:"none"}),!1}},validateHeaders:(e,t)=>!(!e||0===e.length)&&t.every((t=>e.includes(t))),onProjectTypeChange(e){const t=this.typeOptions[e.detail.value];this.projectInfo.type=t.name,this.projectInfo.icon=t.icon},onInspectionTypeChange(e){this.projectInfo.inspectionType=this.inspectionTypes[e.detail.value],this.updateHeadersBasedOnInspectionType()},updateHeadersBasedOnInspectionType(){const e=this.projectInfo.inspectionType;this.headers="坡度"===e?["房间","墙体","坡度(mm/M)","预警状态"]:"平整度"===e?["房间","墙体","平整度(mm)","预警状态"]:["房间","墙体","坡度(mm/M)","平整度(mm)","预警状态"],this.updatePreviewDataForHeaders()},updatePreviewDataForHeaders(){if(this.allData&&this.allData.length>0){const e=this.projectInfo.inspectionType;this.previewData=this.allData.slice(0,10).map((t=>{const n=(()=>{const n=parseFloat(t[2])||0,a=parseFloat(t[3])||0,s=parseFloat(this.warningSettings.slopeWarning)||0,o=parseFloat(this.warningSettings.flatnessWarning)||0;return"坡度"===e?n>s&&s>0?"是":"否":"平整度"===e?a>o&&o>0?"是":"否":n>s&&s>0||a>o&&o>0?"是":"否"})();return"坡度"===e?[t[0],t[1],t[2]||"",n]:"平整度"===e?[t[0],t[1],t[3]||"",n]:[t[0],t[1],t[2]||"",t[3]||"",n]}))}},async importData(){if(!this.importInProgress)if(this.projectInfo.title&&this.projectInfo.address&&this.projectInfo.type&&this.projectInfo.inspectionType)if(this.allData&&0!==this.allData.length){this.importInProgress=!0,uni.showLoading({title:"正在导入..."});try{const e=await this.createProject();await this.createSectionsAndWalls(e),uni.hideLoading(),uni.showToast({title:"导入成功",icon:"success"}),setTimeout((()=>{uni.reLaunch({url:"/pages/index/index"})}),1500)}catch(e){uni.hideLoading(),t("error","at pages/newProject/csv/csv.vue:745","导入失败:",e),uni.showToast({title:"导入失败",icon:"none"})}finally{this.importInProgress=!1}}else uni.showToast({title:"没有可导入的数据",icon:"none"});else uni.showToast({title:"请填写完整项目信息",icon:"none"})},async createProject(){try{const e={icon:this.projectInfo.icon,title:this.projectInfo.title,address:this.projectInfo.address,date:this.projectInfo.date,type_tag:this.projectInfo.type,building:this.projectInfo.building,unit:this.projectInfo.unit,floor:this.projectInfo.floor,room_number:this.projectInfo.roomNumber,inspector:this.projectInfo.inspector,project_status:this.projectInfo.inspectionType,inspection_status:this.projectInfo.inspectionStatus||"未验收"};await n.insertTableData("project",`'${e.icon}','${e.title}','${e.address}','${e.date}','${e.type_tag}','${e.building}','${e.unit}','${e.floor}','${e.room_number}','${e.inspector}','${e.project_status}','${e.inspection_status}'`,"icon,title,address,date,type_tag,building,unit,floor,room_number,inspector,project_status,inspection_status");const t=await new Promise(((e,t)=>{plus.sqlite.selectSql({name:n.dbName,sql:"SELECT last_insert_rowid() as id",success:t=>{e(t)},fail:e=>{t(e)}})}));if(!t||0===t.length)throw new Error("获取项目ID失败");const a=t[0].id;return(this.warningSettings.slopeWarning||this.warningSettings.flatnessWarning)&&await n.insertTableData("warning_settings",`null,${a},${this.warningSettings.slopeWarning||"null"},${this.warningSettings.flatnessWarning||"null"}`,"id,project_id,slope_warning,flatness_warning"),a}catch(e){throw t("error","at pages/newProject/csv/csv.vue:810","创建项目失败:",e),e}},async createSectionsAndWalls(e){try{const t=[...new Set(this.allData.map((e=>e[0])))];for(let a=0;a<t.length;a++)await n.insertTableData("sections",`null,${e},'${t[a]}',${a}`,"id,project_id,name,sort_order");for(const a of this.allData){const t=a[0]||"",s=a[1]||"",o=a[2]||"",i=a[3]||"";s?await n.insertTableData("wall_data",`null,${e},'${t}','${s}','${o}','${i}',''`,"id,project_id,section,wall_name,slope,flatness,image"):await n.insertTableData("wall_data",`null,${e},'${t}','A','','',''`,"id,project_id,section,wall_name,slope,flatness,image")}}catch(a){throw t("error","at pages/newProject/csv/csv.vue:857","创建房间和墙体数据失败:",a),a}},async downloadTemplate(){const e='项目名称,项目地址,验收日期,栋,单元,楼层,房号,项目类型,验收类型,验收状态,项目质检员\n"示例项目","示例地址","2024-03-21","1栋","2单元","3层","301号房","住宅小区","坡度加平整度","未验收","张工"\n预警值设置：坡度预警值(mm/M)：3，平整度预警值(mm)：2\n房间,墙体,坡度(mm/M),平整度(mm)\n"客厅","A","2.5","1.8"\n"客厅","B","3.2","2.1"\n"卧室","A","2.8","1.9"\n"卧室"\n"厨房","A","2.7","1.7"\n"厨房","B"';try{if("undefined"!=typeof plus){const t="wall_measurement_template.csv",n=await new Promise(((e,n)=>{plus.io.resolveLocalFileSystemURL("_downloads/",(a=>{a.getFile(t,{create:!0},(t=>{e(t)}),n)}),n)}));await new Promise(((t,a)=>{n.createWriter((n=>{n.onwrite=t,n.onerror=a,n.write(e)}),a)})),uni.showToast({title:"模板已保存到下载目录",icon:"success"}),plus.runtime.openFile("_downloads/"+t)}else{const t=new Blob([e],{type:"text/csv"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="wall_measurement_template.csv",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}}catch(n){t("error","at pages/newProject/csv/csv.vue:917","下载模板失败:",n),uni.showToast({title:"下载模板失败",icon:"none"})}}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("scroll-view",{class:"scroll-container","scroll-y":""},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"title"},"CSV导入"),e.createElementVNode("view",{class:"subtitle"},"请选择符合格式的CSV文件")]),e.createElementVNode("view",{class:"format-guide"},[e.createElementVNode("view",{class:"guide-title"},"CSV文件格式说明："),e.createElementVNode("view",{class:"guide-content"},[e.createElementVNode("text",null,"1. 第一行为项目信息表头"),e.createElementVNode("text",null,"2. 第二行为项目信息数据"),e.createElementVNode("text",null,"3. 第三行为预警值设置"),e.createElementVNode("text",null,"4. 第四行为墙体数据表头"),e.createElementVNode("text",null,"5. 从第五行开始为房间数据，其中："),e.createElementVNode("text",null,"- 房间名称为必填项（如：客厅）"),e.createElementVNode("text",null,"- 以下数据为可选项："),e.createElementVNode("text",null,"- 墙体编号"),e.createElementVNode("text",null,"- 坡度值(mm/M)"),e.createElementVNode("text",null,"- 平整度值(mm)"),e.createElementVNode("text",null,"- 预警状态"),e.createElementVNode("text",null,"例如："),e.createElementVNode("text",null,'完整格式："客厅","A","2.5","1.8","否"'),e.createElementVNode("text",null,'简单格式："客厅"')]),e.createElementVNode("button",{class:"download-btn",onClick:n[0]||(n[0]=(...e)=>i.downloadTemplate&&i.downloadTemplate(...e))},"下载CSV模板")]),e.createElementVNode("view",{class:"file-section"},[e.createElementVNode("view",{class:"file-box",onClick:n[1]||(n[1]=(...e)=>i.chooseFile&&i.chooseFile(...e))},[o.selectedFile?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("image",{key:0,src:c,class:"upload-icon"})),o.selectedFile?(e.openBlock(),e.createElementBlock("view",{key:2,class:"file-info"},[e.createElementVNode("text",{class:"file-name"},e.toDisplayString(o.selectedFile.name),1),e.createElementVNode("text",{class:"file-size"},e.toDisplayString(i.formatFileSize(o.selectedFile.size)),1)])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"upload-text"},"点击选择CSV文件"))])]),o.previewData.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"project-info"},[e.createElementVNode("view",{class:"info-title"},"项目信息"),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"项目名称："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[2]||(n[2]=e=>o.projectInfo.title=e),placeholder:"项目名称"},null,512),[[e.vModelText,o.projectInfo.title]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"项目地址："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[3]||(n[3]=e=>o.projectInfo.address=e),placeholder:"项目地址"},null,512),[[e.vModelText,o.projectInfo.address]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"验收日期："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[4]||(n[4]=e=>o.projectInfo.date=e),placeholder:"验收日期"},null,512),[[e.vModelText,o.projectInfo.date]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"栋："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[5]||(n[5]=e=>o.projectInfo.building=e),placeholder:"栋"},null,512),[[e.vModelText,o.projectInfo.building]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"单元："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[6]||(n[6]=e=>o.projectInfo.unit=e),placeholder:"单元"},null,512),[[e.vModelText,o.projectInfo.unit]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"楼层："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[7]||(n[7]=e=>o.projectInfo.floor=e),placeholder:"楼层"},null,512),[[e.vModelText,o.projectInfo.floor]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"房号："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[8]||(n[8]=e=>o.projectInfo.roomNumber=e),placeholder:"房号"},null,512),[[e.vModelText,o.projectInfo.roomNumber]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"项目类型："),e.createElementVNode("picker",{class:"input",mode:"selector",range:o.typeOptions,"range-key":"name",onChange:n[9]||(n[9]=(...e)=>i.onProjectTypeChange&&i.onProjectTypeChange(...e))},[e.createElementVNode("view",{class:"picker-text"},e.toDisplayString(o.projectInfo.type||"选择项目类型"),1)],40,["range"])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"项目图标："),e.createElementVNode("view",{class:"icon-wrapper"},[e.createElementVNode("image",{src:o.projectInfo.icon,class:"project-icon",mode:"aspectFit"},null,8,["src"])])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"验收类型："),e.createElementVNode("view",{class:"input disabled-input",onClick:n[10]||(n[10]=(...e)=>i.showInspectionTypeEditTip&&i.showInspectionTypeEditTip(...e))},[e.createElementVNode("view",{class:"picker-text disabled-text"},e.toDisplayString(o.projectInfo.inspectionType||"选择验收类型"),1),e.createElementVNode("text",{class:"edit-tip"},"（如需修改本项请到项目编辑页面）")])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"验收状态："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[11]||(n[11]=e=>o.projectInfo.inspectionStatus=e),placeholder:"验收状态"},null,512),[[e.vModelText,o.projectInfo.inspectionStatus]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"项目质检员："),e.withDirectives(e.createElementVNode("input",{class:"input","onUpdate:modelValue":n[12]||(n[12]=e=>o.projectInfo.inspector=e),placeholder:"项目质检员"},null,512),[[e.vModelText,o.projectInfo.inspector]])])])])):e.createCommentVNode("",!0),o.previewData.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"warning-settings"},[e.createElementVNode("view",{class:"info-title"},"预警值设置"),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"坡度预警值(mm/M)："),e.withDirectives(e.createElementVNode("input",{class:"input",type:"number","onUpdate:modelValue":n[13]||(n[13]=e=>o.warningSettings.slopeWarning=e),placeholder:"坡度预警值(mm/M)"},null,512),[[e.vModelText,o.warningSettings.slopeWarning]])]),e.createElementVNode("view",{class:"input-row"},[e.createElementVNode("text",{class:"input-label"},"平整度预警值(mm)："),e.withDirectives(e.createElementVNode("input",{class:"input",type:"number","onUpdate:modelValue":n[14]||(n[14]=e=>o.warningSettings.flatnessWarning=e),placeholder:"平整度预警值(mm)"},null,512),[[e.vModelText,o.warningSettings.flatnessWarning]])])])])):e.createCommentVNode("",!0),o.previewData.length>0?(e.openBlock(),e.createElementBlock("view",{key:2,class:"preview-section"},[e.createElementVNode("view",{class:"preview-title"},"数据预览"),e.createElementVNode("scroll-view",{"scroll-y":"",class:"preview-table"},[e.createElementVNode("view",{class:"table-header"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.headers,((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"table-cell",key:n},e.toDisplayString(t),1)))),128))]),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.previewData,((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"table-row",key:n},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t,((t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"table-cell",key:n},e.toDisplayString(t),1)))),128))])))),128))])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"import-btn",disabled:!i.canImport,onClick:n[15]||(n[15]=(...e)=>i.importData&&i.importData(...e))}," 导入数据 ",8,["disabled"])])])}],["__scopeId","data-v-6d907147"]]);const g=o({data:()=>({inputText:"",parsedData:null,hasError:!1,errorMessage:"",projectTypes:["学校","办公楼","工业厂房","公寓小区","乡镇住宅","其他"],packageTypes:["坡度","平整度","坡度加平整度"],inspectionStatus:["未验收","已验收"]}),methods:{onInput(e){const t=e.detail?e.detail.value:e.target.value;this.inputText=t,this.hasError=!1,this.errorMessage="",this.parsedData=null},pasteFromClipboard(){uni.getClipboardData({success:e=>{e.data&&e.data.trim()?this.$nextTick((()=>{this.inputText=e.data.trim(),this.hasError=!1,this.errorMessage="",this.parsedData=null,uni.showToast({title:"粘贴成功",icon:"success"})})):uni.showToast({title:"剪贴板为空",icon:"none"})},fail:()=>{uni.showToast({title:"粘贴失败",icon:"none"})}})},copyExample(){uni.setClipboardData({data:"项目名称：衡阳示范小区\n项目地址：湖南省衡阳市珠晖区东风路123号\n验收日期：2024-03-21\n项目类型：公寓小区\n验收类型：坡度加平整度\n验收状态：未验收\n栋：\n单元：2单元\n楼层：\n房号：601\n项目质检员：\n\n客厅：A,2.5,1.8\n客厅：B,3.2,2.1\n卧室1：A,2.8,1.9\n卧室2：\n厨房：\n卫生间：",success:()=>{uni.showToast({title:"示例文本已复制到剪贴板",icon:"success"})},fail:()=>{uni.showToast({title:"复制失败",icon:"none"})}})},parseText(){if(this.inputText.trim())try{const e=this.inputText.split("\n").filter((e=>e.trim())),t={},n=[];let a="project";for(let o of e)if(o=o.trim(),o)if(o.includes("：")&&o.includes(",")&&(a="room"),"project"===a){if(o.includes("：")){const[e,n]=o.split("：",2),a=e.trim(),s=n.trim();switch(a){case"项目名称":t.title=s;break;case"项目地址":t.address=s;break;case"验收日期":t.date=s;break;case"项目类型":t.typeTag=s;break;case"验收类型":t.projectStatus=s;break;case"验收状态":t.inspectionStatus=s;break;case"栋":t.building=s;break;case"单元":t.unit=s;break;case"楼层":t.floor=s;break;case"房号":t.roomNumber=s;break;case"项目质检员":t.inspector=s}}}else if(o.includes("：")){const[e,t]=o.split("：",2),a=e.trim(),s=t?t.split(",").map((e=>e.trim())):[];n.push({room:a||null,wall:s[0]||"",slope:s[1]||"",flatness:s[2]||""})}const s=["title","address","date","typeTag","projectStatus","inspectionStatus"];for(let o of s)if(!t[o])return void this.showError(`缺少必填项：${this.getFieldName(o)}`);if(!this.projectTypes.includes(t.typeTag))return void this.showError(`项目类型必须是：${this.projectTypes.join("、")}`);if(!this.packageTypes.includes(t.projectStatus))return void this.showError(`验收类型必须是：${this.packageTypes.join("、")}`);if(!this.inspectionStatus.includes(t.inspectionStatus))return void this.showError(`验收状态必须是：${this.inspectionStatus.join("、")}`);if(!/^\d{4}-\d{2}-\d{2}$/.test(t.date))return void this.showError("验收日期格式必须为：YYYY-MM-DD");if(0===n.length)return void this.showError("至少需要输入一个房间或墙体数据");this.parsedData={projectInfo:t,roomData:n},this.hasError=!1,this.errorMessage="",uni.showToast({title:"解析成功",icon:"success"})}catch(e){t("error","at pages/newProject/text/text.vue:363","解析失败:",e),this.showError("解析失败，请检查格式")}else this.showError("请输入项目信息")},getFieldName:e=>({title:"项目名称",address:"项目地址",date:"验收日期",typeTag:"项目类型",projectStatus:"验收类型",inspectionStatus:"验收状态"}[e]||e),showError(e){this.hasError=!0,this.errorMessage=e,this.parsedData=null},createProject(){if(!this.parsedData)return void uni.showToast({title:"请先解析文本",icon:"none"});const{projectInfo:e,roomData:t}=this.parsedData,a=`INSERT INTO project (\n\t\t\t\ticon, title, address, date, type_tag,\n\t\t\t\tbuilding, unit, floor, room_number, inspector,\n\t\t\t\tproject_status, inspection_status\n\t\t\t) VALUES (${[{"学校":"/static/image/home1.png","办公楼":"/static/image/home2.png","工业厂房":"/static/image/home3.png","公寓小区":"/static/image/home4.png","乡镇住宅":"/static/image/home5.png","其他":"/static/image/home6.png"}[e.typeTag]||"/static/image/home1.png",e.title,e.address,e.date,e.typeTag,e.building||"",e.unit||"",e.floor||"",e.roomNumber||"",e.inspector||"",e.projectStatus,e.inspectionStatus].map((e=>`'${e}'`)).join(", ")})`;n.isOpen()?this.insertProject(a,t):n.openSqlite().then((()=>this.insertProject(a,t)))},insertProject(e,a){plus.sqlite.executeSql({name:n.dbName,sql:e,success:()=>{t("log","at pages/newProject/text/text.vue:440","项目插入成功"),plus.sqlite.selectSql({name:n.dbName,sql:"SELECT last_insert_rowid() as id",success:e=>{const t=e[0].id;this.insertRoomData(t,a)},fail:e=>{t("error","at pages/newProject/text/text.vue:450","获取项目ID失败",e),uni.showToast({title:"创建项目失败",icon:"none"})}})},fail:e=>{t("error","at pages/newProject/text/text.vue:456","项目插入失败",e),uni.showToast({title:"创建项目失败",icon:"none"})}})},insertRoomData(e,a){let s=0;const o=a.length;a.forEach((a=>(a=>{const i=a.wall||"默认墙体",l=`INSERT INTO wall_data (\n\t\t\t\t\tproject_id, section, wall_name, slope, flatness\n\t\t\t\t) VALUES (${e}, ${a.room?`'${a.room}'`:"NULL"}, '${i}', '${a.slope}', '${a.flatness}')`;plus.sqlite.executeSql({name:n.dbName,sql:l,success:()=>{s++,s===o&&(uni.showToast({title:"添加成功",icon:"success"}),setTimeout((()=>uni.reLaunch({url:"/pages/index/index"})),1e3))},fail:e=>{t("error","at pages/newProject/text/text.vue:485","房间数据插入失败",e),uni.showToast({title:"房间数据插入失败",icon:"none"})}})})(a)))}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("scroll-view",{class:"scroll-container","scroll-y":""},[e.createElementVNode("view",{class:"format-guide"},[e.createElementVNode("view",{class:"guide-header"},[e.createElementVNode("text",{class:"guide-icon"},"📋"),e.createElementVNode("text",{class:"guide-title"},"格式说明")]),e.createElementVNode("view",{class:"guide-content"},[e.createElementVNode("view",{class:"section"},[e.createElementVNode("text",{class:"section-title"},"📋 第一部分：基本信息"),e.createElementVNode("text",{class:"required"},"🔴 必填项："),e.createElementVNode("text",{class:"field-item"},"• 项目名称：xxx"),e.createElementVNode("text",{class:"field-item"},"• 项目地址：xxx"),e.createElementVNode("text",{class:"field-item"},"• 验收日期：YYYY-MM-DD"),e.createElementVNode("text",{class:"field-item"},"• 项目类型：[学校/办公楼/工业厂房/公寓小区/乡镇住宅/其他]"),e.createElementVNode("text",{class:"field-item"},"• 验收类型：[坡度/平整度/坡度加平整度]"),e.createElementVNode("text",{class:"field-item"},"• 验收状态：[未验收/已验收]"),e.createElementVNode("text",{class:"optional"},"🟡 选填项："),e.createElementVNode("text",{class:"field-item"},"• 栋：xx栋"),e.createElementVNode("text",{class:"field-item"},"• 单元：xx单元"),e.createElementVNode("text",{class:"field-item"},"• 楼层：xx层"),e.createElementVNode("text",{class:"field-item"},"• 房号：xxx"),e.createElementVNode("text",{class:"field-item"},"• 项目质检员：xxx")]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("text",{class:"section-title"},"🏠 第二部分：房间和墙体数据"),e.createElementVNode("text",{class:"field-item"},"• 房间名称：墙体编号,坡度值,平整度值"),e.createElementVNode("text",{class:"note"},"💡 房间名称和墙体数据均为选填，可以只填写房间名称")])])]),e.createElementVNode("view",{class:"example-section"},[e.createElementVNode("view",{class:"example-header"},[e.createElementVNode("text",{class:"example-icon"},"📄"),e.createElementVNode("text",{class:"example-title"},"示例文本")]),e.createElementVNode("view",{class:"example-content",onClick:n[0]||(n[0]=(...e)=>i.copyExample&&i.copyExample(...e))},[e.createElementVNode("text",{class:"example-line"},"项目名称：衡阳示范小区"),e.createElementVNode("text",{class:"example-line"},"项目地址：湖南省衡阳市珠晖区东风路123号"),e.createElementVNode("text",{class:"example-line"},"验收日期：2024-03-21"),e.createElementVNode("text",{class:"example-line"},"项目类型：公寓小区"),e.createElementVNode("text",{class:"example-line"},"验收类型：坡度加平整度"),e.createElementVNode("text",{class:"example-line"},"验收状态：未验收"),e.createElementVNode("text",{class:"example-line"},"栋："),e.createElementVNode("text",{class:"example-line"},"单元：2单元"),e.createElementVNode("text",{class:"example-line"},"楼层："),e.createElementVNode("text",{class:"example-line"},"房号：601"),e.createElementVNode("text",{class:"example-line"},"项目质检员："),e.createElementVNode("text",{class:"example-line"}),e.createElementVNode("text",{class:"example-line"},"客厅：A,2.5,1.8"),e.createElementVNode("text",{class:"example-line"},"客厅：B,3.2,2.1"),e.createElementVNode("text",{class:"example-line"},"卧室1：A,2.8,1.9"),e.createElementVNode("text",{class:"example-line"},"卧室2："),e.createElementVNode("text",{class:"example-line"},"厨房："),e.createElementVNode("text",{class:"example-line"},"卫生间：")]),e.createElementVNode("text",{class:"copy-tip"},"👆 点击示例文本可复制到剪贴板")]),e.createElementVNode("view",{class:"input-section"},[e.createElementVNode("view",{class:"input-header"},[e.createElementVNode("view",{class:"input-title-group"},[e.createElementVNode("text",{class:"input-icon"},"✏️"),e.createElementVNode("text",{class:"input-title"},"项目信息输入")]),e.createElementVNode("button",{class:"paste-btn",onClick:n[1]||(n[1]=(...e)=>i.pasteFromClipboard&&i.pasteFromClipboard(...e))},[e.createElementVNode("text",null,"一键粘贴")])]),e.createElementVNode("textarea",{class:e.normalizeClass(["text-input",{error:o.hasError}]),value:o.inputText,placeholder:"请粘贴或输入项目信息...",onInput:n[2]||(n[2]=(...e)=>i.onInput&&i.onInput(...e)),"auto-height":!0,maxlength:-1},null,42,["value"]),o.errorMessage?(e.openBlock(),e.createElementBlock("view",{key:0,class:"error-message"},[e.createElementVNode("text",{class:"error-icon"},"⚠️"),e.createElementVNode("text",null,e.toDisplayString(o.errorMessage),1)])):e.createCommentVNode("",!0)]),o.parsedData?(e.openBlock(),e.createElementBlock("view",{key:0,class:"preview-section"},[e.createElementVNode("view",{class:"preview-header"},[e.createElementVNode("text",{class:"preview-icon"},"👁️"),e.createElementVNode("text",{class:"preview-title"},"解析结果预览")]),e.createElementVNode("view",{class:"preview-content"},[e.createElementVNode("view",{class:"project-info"},[e.createElementVNode("text",{class:"info-title"},"📋 项目信息"),e.createElementVNode("text",{class:"info-item"},"项目名称："+e.toDisplayString(o.parsedData.projectInfo.title),1),e.createElementVNode("text",{class:"info-item"},"项目地址："+e.toDisplayString(o.parsedData.projectInfo.address),1),e.createElementVNode("text",{class:"info-item"},"验收日期："+e.toDisplayString(o.parsedData.projectInfo.date),1),e.createElementVNode("text",{class:"info-item"},"项目类型："+e.toDisplayString(o.parsedData.projectInfo.typeTag),1),e.createElementVNode("text",{class:"info-item"},"验收类型："+e.toDisplayString(o.parsedData.projectInfo.projectStatus),1),e.createElementVNode("text",{class:"info-item"},"验收状态："+e.toDisplayString(o.parsedData.projectInfo.inspectionStatus),1),o.parsedData.projectInfo.building?(e.openBlock(),e.createElementBlock("text",{key:0,class:"info-item"},"栋："+e.toDisplayString(o.parsedData.projectInfo.building),1)):e.createCommentVNode("",!0),o.parsedData.projectInfo.unit?(e.openBlock(),e.createElementBlock("text",{key:1,class:"info-item"},"单元："+e.toDisplayString(o.parsedData.projectInfo.unit),1)):e.createCommentVNode("",!0),o.parsedData.projectInfo.floor?(e.openBlock(),e.createElementBlock("text",{key:2,class:"info-item"},"楼层："+e.toDisplayString(o.parsedData.projectInfo.floor),1)):e.createCommentVNode("",!0),o.parsedData.projectInfo.roomNumber?(e.openBlock(),e.createElementBlock("text",{key:3,class:"info-item"},"房号："+e.toDisplayString(o.parsedData.projectInfo.roomNumber),1)):e.createCommentVNode("",!0),o.parsedData.projectInfo.inspector?(e.openBlock(),e.createElementBlock("text",{key:4,class:"info-item"},"项目质检员："+e.toDisplayString(o.parsedData.projectInfo.inspector),1)):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"room-data"},[e.createElementVNode("text",{class:"info-title"},"🏠 房间数据"),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.parsedData.roomData,((t,n)=>(e.openBlock(),e.createElementBlock("text",{key:n,class:"info-item"},e.toDisplayString(t.room||"未分类")+"："+e.toDisplayString(t.wall||"")+e.toDisplayString(t.slope?","+t.slope:"")+e.toDisplayString(t.flatness?","+t.flatness:""),1)))),128))])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"bottom-spacer"})]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"preview-btn",onClick:n[3]||(n[3]=(...e)=>i.parseText&&i.parseText(...e)),disabled:!o.inputText.trim()},[e.createElementVNode("text",null,"预览解析")],8,["disabled"]),e.createElementVNode("button",{class:"create-btn",onClick:n[4]||(n[4]=(...e)=>i.createProject&&i.createProject(...e)),disabled:!o.parsedData},[e.createElementVNode("text",null,"创建项目")],8,["disabled"])])])}],["__scopeId","data-v-6b4d5c10"]]);const w=o({data:()=>({projectId:null,typeOptions:[{name:"学校",icon:"/static/image/home1.png"},{name:"办公楼",icon:"/static/image/home2.png"},{name:"工业厂房",icon:"/static/image/home3.png"},{name:"公寓小区",icon:"/static/image/home4.png"},{name:"乡镇住宅",icon:"/static/image/home5.png"},{name:"其他",icon:"/static/image/home6.png"}],packageOptions:["坡度","平整度","坡度加平整度"],inspectionStatusOptions:["未验收","已验收"],projectFields:[{key:"title",label:"项目名称"},{key:"address",label:"项目地址"},{key:"date",label:"验收日期"},{key:"building",label:"栋"},{key:"unit",label:"单元"},{key:"floor",label:"楼层"},{key:"room_number",label:"房号"},{key:"inspector",label:"质检员"}],form:{icon:"/static/image/home1.png",type_tag:"",title:"",address:"",date:"",building:"",unit:"",floor:"",room_number:"",inspector:"",project_status:"坡度加平整度",inspection_status:"未验收"}}),onLoad(e){e.id&&(this.projectId=e.id,this.loadProjectById(this.projectId))},methods:{onTypeSelect(e){const t=this.typeOptions[e];this.form.type_tag=t.name,this.form.icon=t.icon},onDateChange(e){this.form.date=e.detail.value},onPackageChange(e){this.form.project_status=this.packageOptions[e.detail.value]},onInspectionStatusChange(e){this.form.inspection_status=this.inspectionStatusOptions[e.detail.value]},async getLocation(){const e=this;uni.getLocation({type:"wgs84",success(t){uni.request({url:`https://apis.map.qq.com/ws/geocoder/v1/?location=${t.latitude},${t.longitude}&key=GN4BZ-LSR64-7DAUI-DB246-CUPM3-5HBMM`,success(t){if(t.data&&t.data.result){const n=t.data.result.formatted_addresses&&t.data.result.formatted_addresses.standard_address||t.data.result.address;e.form.address=n}else uni.showToast({title:"定位失败",icon:"none"})},fail(){uni.showToast({title:"定位失败",icon:"none"})}})},fail(){uni.showToast({title:"获取定位失败",icon:"none"})}})},loadProjectById(e){const t=`SELECT * FROM project WHERE id = '${e}'`;n.isOpen()?this.fetchProject(t):n.openSqlite().then((()=>this.fetchProject(t)))},fetchProject(e){plus.sqlite.selectSql({name:n.dbName,sql:e,success:e=>{if(e&&e.length>0){const t=e[0];for(const e in this.form)void 0!==t[e]&&(this.form[e]=t[e])}},fail:e=>{t("error","at pages/inProject/edit/edit.vue:189","查询失败",e),uni.showToast({title:"加载失败",icon:"none"})}})},submit(){if(!this.form.title.trim())return void uni.showToast({title:"请输入项目名称",icon:"none"});if(!this.form.address.trim())return void uni.showToast({title:"请输入项目地址",icon:"none"});if(!this.form.date.trim())return void uni.showToast({title:"请输入验收日期",icon:"none"});const e=`\n\t\t\t\tUPDATE project SET\n\t\t\t\t\ticon='${this.form.icon}',\n\t\t\t\t\ttitle='${this.form.title}',\n\t\t\t\t\taddress='${this.form.address}',\n\t\t\t\t\tdate='${this.form.date}',\n\t\t\t\t\ttype_tag='${this.form.type_tag}',\n\t\t\t\t\tbuilding='${this.form.building}',\n\t\t\t\t\tunit='${this.form.unit}',\n\t\t\t\t\tfloor='${this.form.floor}',\n\t\t\t\t\troom_number='${this.form.room_number}',\n\t\t\t\t\tinspector='${this.form.inspector}',\n\t\t\t\t\tproject_status='${this.form.project_status}',\n\t\t\t\t\tinspection_status='${this.form.inspection_status}'\n\t\t\t\tWHERE id = '${this.projectId}'\n\t\t\t`;n.isOpen()?this.updateProject(e):n.openSqlite().then((()=>this.updateProject(e)))},updateProject(e){plus.sqlite.executeSql({name:n.dbName,sql:e,success:()=>{t("log","at pages/inProject/edit/edit.vue:236","更新成功"),uni.showToast({title:"更新成功",icon:"success"}),setTimeout((()=>uni.navigateBack()),1e3)},fail:e=>{t("error","at pages/inProject/edit/edit.vue:241","更新失败",e),uni.showToast({title:"更新失败",icon:"none"})}})}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"main"},[e.createElementVNode("scroll-view",{"scroll-y":"true",class:"scroll-view"},[e.createElementVNode("view",{class:"container"},[e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"form-title"},"项目信息"),e.createElementVNode("view",{class:"form-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.projectFields,(t=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["form-item",{"full-width":"address"===t.key||"title"===t.key}]),key:t.key},["address"===t.key?(e.openBlock(),e.createElementBlock("view",{key:0,class:"label-with-button"},[e.createElementVNode("text",{class:"label"},e.toDisplayString(t.label),1),e.createElementVNode("button",{class:"location-btn",type:"default",size:"mini",onClick:n[0]||(n[0]=(...e)=>i.getLocation&&i.getLocation(...e))},[e.createElementVNode("text",{class:"location-text"},"获取定位")])])):(e.openBlock(),e.createElementBlock("text",{key:1,class:"label"},e.toDisplayString(t.label),1)),"address"===t.key?(e.openBlock(),e.createElementBlock("view",{key:2,class:"address-container"},[e.withDirectives(e.createElementVNode("input",{class:"input address-input","onUpdate:modelValue":e=>o.form[t.key]=e,placeholder:"请输入"+t.label},null,8,["onUpdate:modelValue","placeholder"]),[[e.vModelText,o.form[t.key]]])])):"date"===t.key?(e.openBlock(),e.createElementBlock("picker",{key:3,mode:"date",value:o.form[t.key],onChange:n[1]||(n[1]=(...e)=>i.onDateChange&&i.onDateChange(...e))},[e.createElementVNode("view",{class:"picker-view"},e.toDisplayString(o.form[t.key]||"请选择"+t.label),1)],40,["value"])):e.withDirectives((e.openBlock(),e.createElementBlock("input",{key:4,class:"input","onUpdate:modelValue":e=>o.form[t.key]=e,placeholder:"请输入"+t.label},null,8,["onUpdate:modelValue","placeholder"])),[[e.vModelText,o.form[t.key]]])],2)))),128))])]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"form-title"},"项目类型"),e.createElementVNode("view",{class:"type-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.typeOptions,((t,n)=>(e.openBlock(),e.createElementBlock("view",{key:t.name,class:e.normalizeClass(["type-item",{active:o.form.type_tag===t.name}]),onClick:e=>i.onTypeSelect(n)},[e.createElementVNode("image",{src:t.icon,class:"type-icon",mode:"aspectFit"},null,8,["src"]),e.createElementVNode("text",{class:"type-name"},e.toDisplayString(t.name),1)],10,["onClick"])))),128))])]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"form-title"},"状态信息"),e.createElementVNode("view",{class:"form-grid"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"label"},"验收类型"),e.createElementVNode("picker",{range:o.packageOptions,onChange:n[2]||(n[2]=(...e)=>i.onPackageChange&&i.onPackageChange(...e))},[e.createElementVNode("view",{class:"picker-view"},e.toDisplayString(o.form.project_status||"请选择验收类型"),1)],40,["range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"label"},"验收状态"),e.createElementVNode("picker",{range:o.inspectionStatusOptions,onChange:n[3]||(n[3]=(...e)=>i.onInspectionStatusChange&&i.onInspectionStatusChange(...e))},[e.createElementVNode("view",{class:"picker-view"},e.toDisplayString(o.form.inspection_status||"请选择验收状态"),1)],40,["range"])])])])])]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"submit-btn",onClick:n[4]||(n[4]=(...e)=>i.submit&&i.submit(...e))},"修改项目")])])}]]);const v=o({data:()=>({fileName:"",fileSize:"",createTime:"",content:"",tableHeaders:["房间","墙体","坡度(mm/M)","平整度(mm)"],tableData:[],projectInfo:null,warningSettings:null,savedFilePath:""}),computed:{formattedProjectInfo(){return this.projectInfo?{"项目名称":this.projectInfo.title,"项目地址":this.projectInfo.address,"验收日期":this.projectInfo.date,"栋":this.projectInfo.building,"单元":this.projectInfo.unit,"楼层":this.projectInfo.floor,"房号":this.projectInfo.roomNumber,"项目类型":this.projectInfo.typeTag,"验收类型":this.projectInfo.projectStatus,"验收状态":this.projectInfo.inspectionStatus,"项目质检员":this.projectInfo.inspector}:{}}},onLoad(e){if("android"===plus.os.name.toLowerCase()&&plus.android.requestPermissions(["android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],(function(e){2===e.granted.length?t("log","at pages/newProject/csv/preview/preview.vue:143","存储权限已授予"):uni.showToast({title:"请授予存储权限以保存文件",icon:"none",duration:2e3})}),(function(e){t("error","at pages/newProject/csv/preview/preview.vue:153","请求权限失败:",e)})),e.data)try{const t=JSON.parse(decodeURIComponent(e.data));this.content=t.content,this.fileName=t.fileName,this.createTime=t.createTime,this.projectInfo=t.projectInfo,this.warningSettings=t.warningSettings,this.fileSize=this.calculateFileSize(this.content),this.setTableHeadersBasedOnProjectInfo(),this.parseCSVToTable(this.content)}catch(n){t("error","at pages/newProject/csv/preview/preview.vue:176","解析数据失败:",n),uni.showToast({title:"数据加载失败",icon:"none"})}},methods:{calculateFileSize:e=>p.calculateFileSize(e),parseCSVToTable(e){try{const t=p.parseCSVContent(e);t?(this.tableHeaders=t.headers,this.tableData=t.tableData):this.setTableHeadersBasedOnProjectInfo()}catch(n){t("error","at pages/newProject/csv/preview/preview.vue:201","解析CSV数据失败:",n),this.setTableHeadersBasedOnProjectInfo()}},setTableHeadersBasedOnProjectInfo(){if(!this.projectInfo)return void(this.tableHeaders=["房间","墙体","坡度(mm/M)","平整度(mm)","预警状态"]);const e=this.projectInfo.projectStatus;let t=["房间","墙体"];"坡度"===e?t.push("坡度(mm/M)"):"平整度"===e?t.push("平整度(mm)"):t.push("坡度(mm/M)","平整度(mm)"),t.push("预警状态"),this.tableHeaders=t},async saveAndShare(){try{const o=p.processCSVContent(this.content);if("undefined"!=typeof plus){const i=this.fileName;let l="";try{if("android"===plus.os.name.toLowerCase()){const s=plus.android.runtimeMainActivity(),c=(plus.android.importClass("android.content.Context"),plus.android.importClass("java.io.File")),r=(plus.android.importClass("java.io.FileOutputStream"),new c(s.getExternalFilesDir(null),"exports"));r.exists()||r.mkdirs();const p=new c(r,i);l=p.getAbsolutePath(),t("log","at pages/newProject/csv/preview/preview.vue:263","准备写入的内容长度:",o.length);try{const e=plus.android.importClass("java.io.FileOutputStream"),n=plus.android.importClass("java.io.OutputStreamWriter"),a=plus.android.importClass("java.io.BufferedWriter"),s=new a(new n(new e(p),"GBK"));s.write(o),s.flush(),s.close();const i=plus.android.importClass("java.io.FileInputStream"),l=plus.android.importClass("java.io.InputStreamReader"),c=plus.android.importClass("java.io.BufferedReader"),r=new i(p),d=new c(new l(r,"GBK")),m=new(plus.android.importClass("java.lang.StringBuilder"));let u;for(;null!=(u=d.readLine());)m.append(u).append("\n");d.close(),r.close();const h=m.toString();if(t("log","at pages/newProject/csv/preview/preview.vue:295","文件写入后的内容长度:",h.length),0===h.length)throw new Error("文件写入后内容为空")}catch(e){throw t("error","at pages/newProject/csv/preview/preview.vue:300","文件写入失败:",e),e}t("log","at pages/newProject/csv/preview/preview.vue:304","文件保存路径:",l),this.savedFilePath=l;try{const e=plus.android.importClass("android.content.Intent"),n=plus.android.importClass("androidx.core.content.FileProvider"),a=new e(e.ACTION_SEND);a.setType("text/csv");const o=s.getPackageName()+".fileprovider";t("log","at pages/newProject/csv/preview/preview.vue:316","FileProvider authority:",o);const i=n.getUriForFile(s,o,p);t("log","at pages/newProject/csv/preview/preview.vue:320","文件大小:",p.length(),"bytes"),a.addFlags(e.FLAG_GRANT_READ_URI_PERMISSION),a.putExtra(e.EXTRA_STREAM,i);const l=e.createChooser(a,"分享文件");l.addFlags(e.FLAG_ACTIVITY_NEW_TASK),s.startActivity(l),uni.showToast({title:"请选择分享方式",icon:"none"})}catch(n){t("error","at pages/newProject/csv/preview/preview.vue:334","创建分享Intent失败:",n);try{const e=plus.android.importClass("android.os.Environment"),n=new c(e.getExternalStoragePublicDirectory(e.DIRECTORY_DOWNLOADS),i),a=new c(l),s=plus.android.importClass("java.io.FileInputStream"),o=plus.android.importClass("java.io.FileOutputStream"),r=new s(a),p=new o(n),d=new plus.android.invoke("byte[]",1024);let m;for(;(m=r.read(d))>0;)p.write(d,0,m);p.close(),r.close();const u=n.length();if(t("log","at pages/newProject/csv/preview/preview.vue:357","复制后的文件大小:",u,"bytes"),!(u>0))throw new Error("复制后的文件为空");uni.showToast({title:"文件已保存到下载目录",icon:"success"}),plus.runtime.openFile(n.getAbsolutePath())}catch(a){t("error","at pages/newProject/csv/preview/preview.vue:371","复制文件失败:",a),uni.showToast({title:"无法保存文件",icon:"none"})}}}else{const e=plus.io.convertLocalFileSystemURL("_doc");await new Promise(((e,t)=>{plus.io.requestFileSystem(plus.io.PRIVATE_DOC,(n=>{n.root.getDirectory("exports",{create:!0},(t=>{e(t)}),t)}),t)})),l=e+"/exports/"+i;const n=await new Promise(((e,t)=>{plus.io.resolveLocalFileSystemURL("_doc/exports/",(n=>{n.getFile(i,{create:!0},(t=>{e(t)}),t)}),t)}));await new Promise(((e,t)=>{n.createWriter((n=>{n.onwrite=e,n.onerror=t,n.write(o)}),t)})),this.savedFilePath=l,plus.share.sendWithSystem({type:"file",filePath:this.savedFilePath,success:()=>{uni.showToast({title:"分享成功",icon:"success"})},fail:e=>{t("error","at pages/newProject/csv/preview/preview.vue:421","分享失败:",e),uni.showToast({title:"分享失败",icon:"none"})}})}}catch(s){t("error","at pages/newProject/csv/preview/preview.vue:430","分享文件失败:",s),uni.showToast({title:"分享失败，请重试",icon:"none",duration:2e3})}}else{const e=new Blob([o],{type:"text/csv"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=this.fileName,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),uni.showToast({title:"文件已下载",icon:"success"})}}catch(s){t("error","at pages/newProject/csv/preview/preview.vue:454","保存或分享文件失败:",s),uni.showToast({title:"操作失败，请检查存储权限和剩余空间",icon:"none",duration:2e3})}},uploadToCloud(){uni.showToast({title:"云端上传功能开发中",icon:"none"})},copyContent(){try{const e=p.processCSVContent(this.content);uni.setClipboardData({data:e,success:()=>{uni.showToast({title:"已复制到剪贴板",icon:"success"})},fail:()=>{uni.showToast({title:"复制失败",icon:"none"})}})}catch(e){t("error","at pages/newProject/csv/preview/preview.vue:491","复制内容失败:",e),uni.showToast({title:"复制失败",icon:"none"})}},viewFile(){try{const n=p.processCSVContent(this.content);if("undefined"==typeof plus){const e=new Blob([n],{type:"text/csv"}),t=URL.createObjectURL(e);return window.open(t),void URL.revokeObjectURL(t)}const a=this.fileName,s="_downloads/"+a;try{plus.io.resolveLocalFileSystemURL(s,(e=>{e.remove((()=>{t("log","at pages/newProject/csv/preview/preview.vue:520","已删除旧文件"),this.createAndOpenFile(n,a)}),(e=>{t("error","at pages/newProject/csv/preview/preview.vue:524","删除旧文件失败:",e),this.createAndOpenFile(n,a)}))}),(e=>{t("log","at pages/newProject/csv/preview/preview.vue:529","文件不存在，直接创建新文件"),this.createAndOpenFile(n,a)}))}catch(e){t("error","at pages/newProject/csv/preview/preview.vue:534","文件操作失败:",e),uni.showToast({title:"文件操作失败",icon:"none"})}}catch(n){t("error","at pages/newProject/csv/preview/preview.vue:541","查看文件失败:",n),uni.showToast({title:"查看文件失败",icon:"none"})}},createAndOpenFile(e,n){const a="_downloads/"+n;plus.io.resolveLocalFileSystemURL("_downloads/",(s=>{s.getFile(n,{create:!0},(n=>{n.createWriter((n=>{n.onwrite=()=>{t("log","at pages/newProject/csv/preview/preview.vue:556","文件写入成功"),plus.runtime.openFile(a,"",(e=>{t("error","at pages/newProject/csv/preview/preview.vue:559","打开文件失败:",e),uni.showToast({title:"没有找到可以打开此文件的应用程序",icon:"none"})}))},n.onerror=e=>{t("error","at pages/newProject/csv/preview/preview.vue:567","文件写入失败:",e),uni.showToast({title:"文件写入失败",icon:"none"})},n.write(e)}),(e=>{t("error","at pages/newProject/csv/preview/preview.vue:575","创建文件写入器失败:",e),uni.showToast({title:"文件操作失败",icon:"none"})}))}),(e=>{t("error","at pages/newProject/csv/preview/preview.vue:582","创建文件失败:",e),uni.showToast({title:"文件创建失败",icon:"none"})}))}),(e=>{t("error","at pages/newProject/csv/preview/preview.vue:589","获取下载目录失败:",e),uni.showToast({title:"获取存储目录失败",icon:"none"})}))}}},[["render",function(t,n,a,s,o,i){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"file-info"},[e.createElementVNode("view",{class:"info-title"},"文件信息："),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"名称："),e.createElementVNode("text",{class:"value"},e.toDisplayString(o.fileName),1)]),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"大小："),e.createElementVNode("text",{class:"value"},e.toDisplayString(o.fileSize),1)]),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"创建时间："),e.createElementVNode("text",{class:"value"},e.toDisplayString(o.createTime),1)])]),e.createElementVNode("view",{class:"table-section"},[e.createElementVNode("view",{class:"section-title"},"项目信息"),e.createElementVNode("view",{class:"table-wrapper"},[e.createElementVNode("table",{class:"info-table"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(i.formattedProjectInfo,((t,n)=>(e.openBlock(),e.createElementBlock("tr",{key:n},[e.createElementVNode("td",{class:"label-cell"},e.toDisplayString(n)+"：",1),e.createElementVNode("td",{class:"value-cell"},e.toDisplayString(t),1)])))),128))])])]),o.warningSettings?(e.openBlock(),e.createElementBlock("view",{key:0,class:"table-section"},[e.createElementVNode("view",{class:"section-title"},"预警设置"),e.createElementVNode("view",{class:"table-wrapper"},[e.createElementVNode("table",{class:"info-table"},[e.createElementVNode("tr",null,[e.createElementVNode("td",{class:"label-cell"},"坡度预警值(mm/M)："),e.createElementVNode("td",{class:"value-cell"},e.toDisplayString(o.warningSettings.slopeWarning),1)]),e.createElementVNode("tr",null,[e.createElementVNode("td",{class:"label-cell"},"平整度预警值(mm)："),e.createElementVNode("td",{class:"value-cell"},e.toDisplayString(o.warningSettings.flatnessWarning),1)])])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"table-section"},[e.createElementVNode("view",{class:"section-title"},"墙体数据"),e.createElementVNode("view",{class:"table-wrapper"},[e.createElementVNode("table",{class:"data-table"},[e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.tableHeaders,(t=>(e.openBlock(),e.createElementBlock("th",{key:t},e.toDisplayString(t),1)))),128))])]),e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.tableData,((t,n)=>(e.openBlock(),e.createElementBlock("tr",{key:n},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t,((t,n)=>(e.openBlock(),e.createElementBlock("td",{key:n},e.toDisplayString(t),1)))),128))])))),128))])])])]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("view",{class:"button-group"},[e.createElementVNode("button",{class:"action-btn save",onClick:n[0]||(n[0]=(...e)=>i.saveAndShare&&i.saveAndShare(...e))},[e.createElementVNode("text",{class:"btn-text"},"保存并分享")]),e.createElementVNode("button",{class:"action-btn upload",onClick:n[1]||(n[1]=(...e)=>i.uploadToCloud&&i.uploadToCloud(...e))},[e.createElementVNode("text",{class:"btn-text"},"上传到云端")]),e.createElementVNode("button",{class:"action-btn copy",onClick:n[2]||(n[2]=(...e)=>i.copyContent&&i.copyContent(...e))},[e.createElementVNode("text",{class:"btn-text"},"复制内容")]),e.createElementVNode("button",{class:"action-btn view",onClick:n[3]||(n[3]=(...e)=>i.viewFile&&i.viewFile(...e))},[e.createElementVNode("text",{class:"btn-text"},"查看文件")])])]),e.createElementVNode("view",{class:"tips"},[e.createElementVNode("view",{class:"tips-title"},"提示："),e.createElementVNode("view",{class:"tips-content"},[e.createElementVNode("text",null,"- 支持的文件格式：CSV（逗号分隔值）"),e.createElementVNode("text",null,"- 建议使用 Excel、WPS 等表格软件打开查看"),e.createElementVNode("text",null,"- 如需编辑数据，请在编辑后重新导入系统")])])])}],["__scopeId","data-v-44b16b00"]]);__definePage("pages/index/index",i),__definePage("pages/device/device",l),__definePage("pages/newProject/newProject",r),__definePage("pages/inProject/inProject",d),__definePage("pages/test/test",m),__definePage("pages/newProject/template/template",u),__definePage("pages/newProject/csv/csv",h),__definePage("pages/newProject/text/text",g),__definePage("pages/inProject/edit/edit",w),__definePage("pages/newProject/csv/preview/preview",v);const E="app_config",f={getConfig(){try{return uni.getStorageSync(E)||{}}catch(e){return t("error","at api/config.js:11","获取配置失败：",e),{}}},saveConfig(e){try{uni.setStorageSync(E,e)}catch(n){t("error","at api/config.js:21","保存配置失败：",n)}},updateConfig(e){const t=this.getConfig();this.saveConfig({...t,...e})},isFirstLaunch(){return!this.getConfig().hasLaunched},markLaunched(){this.updateConfig({hasLaunched:!0})}},N={globalData:{dbInitialized:!1},onLaunch:function(){this.initDatabase()},onShow:function(){t("log","at App.vue:14","App Show")},onHide:function(){t("log","at App.vue:17","App Hide")},methods:{async initDatabase(){try{await this.openSQL(),await this.createTables(),f.isFirstLaunch()&&(await this.initSampleData(),f.markLaunched(),t("log","at App.vue:29","示例数据初始化完成")),t("log","at App.vue:32","数据库初始化完成"),this.globalData.dbInitialized=!0}catch(e){t("error","at App.vue:36","数据库初始化失败:",e)}},openSQL:()=>new Promise(((e,a)=>{let s=n.isOpen();t("log","at App.vue:43","数据库状态",s?"开启":"关闭"),s?e():n.openSqlite().then((n=>{t("log","at App.vue:47","数据库已打开"),e(n)})).catch((e=>{t("log","at App.vue:51","数据库开启失败"),a(e)}))})),async createTables(){try{await n.createTable("project",'\n\t\t\t\t\t"id" INTEGER PRIMARY KEY AUTOINCREMENT,\n\t\t\t\t\t"icon" TEXT,\n\t\t\t\t\t"title" TEXT NOT NULL,\n\t\t\t\t\t"address" TEXT NOT NULL,\n\t\t\t\t\t"date" TEXT NOT NULL,\n\t\t\t\t\t"type_tag" TEXT NOT NULL,\n\t\t\t\t\t"building" TEXT,\n\t\t\t\t\t"unit" TEXT,\n\t\t\t\t\t"floor" TEXT,\n\t\t\t\t\t"room_number" TEXT,\n\t\t\t\t\t"inspector" TEXT,\n\t\t\t\t\t"project_status" TEXT NOT NULL,\n\t\t\t\t\t"inspection_status" TEXT NOT NULL\n\t\t\t\t'),t("log","at App.vue:78","项目表创建成功"),await n.createTable("wall_data",'\n\t\t\t\t\t"id" INTEGER PRIMARY KEY AUTOINCREMENT,\n\t\t\t\t\t"project_id" INTEGER NOT NULL,\n\t\t\t\t\t"section" TEXT,\n\t\t\t\t\t"wall_name" TEXT NOT NULL,\n\t\t\t\t\t"slope" TEXT,\n\t\t\t\t\t"flatness" TEXT,\n\t\t\t\t\t"image" TEXT,\n\t\t\t\t\tFOREIGN KEY(project_id) REFERENCES project(id)\n\t\t\t\t'),t("log","at App.vue:91","墙体数据表创建成功"),await n.createTable("warning_settings",'\n\t\t\t\t\t"id" INTEGER PRIMARY KEY AUTOINCREMENT,\n\t\t\t\t\t"project_id" INTEGER NOT NULL,\n\t\t\t\t\t"slope_warning" REAL,\n\t\t\t\t\t"flatness_warning" REAL,\n\t\t\t\t\tFOREIGN KEY(project_id) REFERENCES project(id)\n\t\t\t\t'),t("log","at App.vue:101","预警设置表创建成功"),await n.createTable("sections",'\n\t\t\t\t\t"id" INTEGER PRIMARY KEY AUTOINCREMENT,\n\t\t\t\t\t"project_id" INTEGER NOT NULL,\n\t\t\t\t\t"name" TEXT NOT NULL,\n\t\t\t\t\t"sort_order" INTEGER,\n\t\t\t\t\tFOREIGN KEY(project_id) REFERENCES project(id)\n\t\t\t\t'),t("log","at App.vue:111","房间表创建成功")}catch(e){throw t("error","at App.vue:114","创建数据库表失败:",e),e}},async initSampleData(){try{const e={icon:"/static/image/home1.png",title:"示例学校项目",address:"北京市海淀区中关村大街1号",date:(new Date).toISOString().split("T")[0],type_tag:"学校",building:"A栋",unit:"1单元",floor:"3层",room_number:"301",inspector:"张工",project_status:"坡度加平整度",inspection_status:"已验收"},n={icon:"/static/image/home2.png",title:"示例办公楼项目",address:"上海市浦东新区陆家嘴环路1000号",date:(new Date).toISOString().split("T")[0],type_tag:"办公楼",building:"B栋",unit:"2单元",floor:"15层",room_number:"1503",inspector:"李工",project_status:"平整度",inspection_status:"未验收"},a=await this.insertProject(e),s=await this.insertProject(n),o=["客厅","主卧","次卧","卫生间"];for(let t=0;t<o.length;t++)await this.insertSection(a,o[t],t+1);const i=["会议室","办公区","茶水间","洽谈室"];for(let t=0;t<i.length;t++)await this.insertSection(s,i[t],t+1);const l=[{section:"客厅",name:"东墙",slope:"1.2",flatness:"2.5"},{section:"客厅",name:"南墙",slope:"1.5",flatness:"2.8"},{section:"主卧",name:"北墙",slope:"1.1",flatness:"2.3"},{section:"主卧",name:"西墙",slope:"1.3",flatness:"2.6"}];for(const t of l)await this.insertWallData(a,t);const c=[{section:"会议室",name:"东墙",slope:"1.4",flatness:"2.7"},{section:"会议室",name:"南墙",slope:"1.6",flatness:"2.9"},{section:"办公区",name:"北墙",slope:"1.2",flatness:"2.4"}];for(const t of c)await this.insertWallData(s,t);await this.insertWarningSettings(a,2,3),await this.insertWarningSettings(s,1.8,2.8),t("log","at App.vue:197","示例数据添加成功")}catch(e){throw t("error","at App.vue:199","添加示例数据失败:",e),e}},async insertProject(e){const t=`INSERT INTO project (\n\t\t\t\ticon, title, address, date, type_tag,\n\t\t\t\tbuilding, unit, floor, room_number, inspector,\n\t\t\t\tproject_status, inspection_status\n\t\t\t) VALUES (\n\t\t\t\t'${e.icon}', '${e.title}', '${e.address}', \n\t\t\t\t'${e.date}', '${e.type_tag}', '${e.building}',\n\t\t\t\t'${e.unit}', '${e.floor}', '${e.room_number}',\n\t\t\t\t'${e.inspector}', '${e.project_status}', \n\t\t\t\t'${e.inspection_status}'\n\t\t\t)`;return new Promise(((e,a)=>{plus.sqlite.executeSql({name:n.dbName,sql:t,success:t=>{plus.sqlite.selectSql({name:n.dbName,sql:"SELECT last_insert_rowid() as id",success:t=>e(t[0].id),fail:e=>a(e)})},fail:e=>a(e)})}))},async insertSection(e,t,a){const s=`INSERT INTO sections (project_id, name, sort_order) \n\t\t\t\t\t\tVALUES (${e}, '${t}', ${a})`;return new Promise(((e,t)=>{plus.sqlite.executeSql({name:n.dbName,sql:s,success:()=>e(),fail:e=>t(e)})}))},async insertWallData(e,t){const a=`INSERT INTO wall_data (\n\t\t\t\tproject_id, section, wall_name, slope, flatness\n\t\t\t) VALUES (\n\t\t\t\t${e}, '${t.section}', '${t.name}', \n\t\t\t\t'${t.slope}', '${t.flatness}'\n\t\t\t)`;return new Promise(((e,t)=>{plus.sqlite.executeSql({name:n.dbName,sql:a,success:()=>e(),fail:e=>t(e)})}))},async insertWarningSettings(e,t,a){const s=`INSERT INTO warning_settings (\n\t\t\t\tproject_id, slope_warning, flatness_warning\n\t\t\t) VALUES (\n\t\t\t\t${e}, ${t}, ${a}\n\t\t\t)`;return new Promise(((e,t)=>{plus.sqlite.executeSql({name:n.dbName,sql:s,success:()=>e(),fail:e=>t(e)})}))}}};const{app:T,Vuex:j,Pinia:y}={app:e.createVueApp(N)};uni.Vuex=j,uni.Pinia=y,T.provide("__globalStyles",__uniConfig.styles),T._component.mpType="app",T._component.render=()=>{},T.mount("#app")}(Vue);
